{% extends "layout_student.html" %}
{% set page_title = "Finances" %}
{% set current_page = "transfer" %}
{% block title %}Finances{% endblock %}
{% block page_icon %}account_balance_wallet{% endblock %}

{% block content %}
<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="financesTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button" role="tab">
            <span class="material-symbols-outlined">account_balance</span> Accounts
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transfer-tab" data-bs-toggle="tab" data-bs-target="#transfer" type="button" role="tab">
            <span class="material-symbols-outlined">swap_horiz</span> Transfer
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button" role="tab">
            <span class="material-symbols-outlined">send</span> Send to Student
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
            <span class="material-symbols-outlined">receipt_long</span> Transactions
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="financesTabContent">
    <!-- Accounts Tab -->
    <div class="tab-pane fade show active" id="accounts" role="tabpanel">
        <div class="row">
            <!-- Account Balances -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">account_balance</span> Account Balances
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-primary bg-opacity-10 rounded">
                                    <span class="material-symbols-outlined text-primary" style="font-size: 2.5rem;">account_balance_wallet</span>
                                    <h6 class="text-muted mt-2 mb-1">Checking</h6>
                                    <h3 class="text-primary mb-0">${{ "%.2f"|format(student.checking_balance) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-success bg-opacity-10 rounded">
                                    <span class="material-symbols-outlined text-success" style="font-size: 2.5rem;">savings</span>
                                    <h6 class="text-muted mt-2 mb-1">Savings</h6>
                                    <h3 class="text-success mb-0">${{ "%.2f"|format(student.savings_balance) }}</h3>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <h6 class="text-muted">Total Balance</h6>
                            <h2 class="text-primary mb-0">${{ "%.2f"|format(student.checking_balance + student.savings_balance) }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Statistics -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">analytics</span> Statistics
                    </div>
                    <div class="card-body">
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Earnings</span>
                                <h5 class="mb-0 text-success">${{ "%.2f"|format(student.total_earnings) }}</h5>
                            </div>
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Monthly Interest Rate</span>
                                <h5 class="mb-0 text-info">{% if settings %}{{ "%.2f"|format(settings.savings_monthly_rate) }}%{% else %}4.5%{% endif %}</h5>
                            </div>
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Estimated Monthly Interest</span>
                                <h5 class="mb-0 text-info">${{ "%.2f"|format(forecast_interest) }}</h5>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total Transactions</span>
                                <h5 class="mb-0">{%if transactions %}{{ transactions|length }}{% else %}0{% endif %}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <span class="material-symbols-outlined">bolt</span> Quick Actions
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-primary w-100" onclick="document.getElementById('transfer-tab').click()">
                            <span class="material-symbols-outlined">swap_horiz</span> Transfer Funds
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="document.getElementById('transactions-tab').click()">
                            <span class="material-symbols-outlined">receipt_long</span> View Transactions
                        </button>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('student.dashboard') }}" class="btn btn-outline-secondary w-100">
                            <span class="material-symbols-outlined">dashboard</span> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Tab -->
    <div class="tab-pane fade" id="transfer" role="tabpanel">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="material-symbols-outlined">account_balance</span> Current Balances
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                    <h6 class="text-muted mb-2">Checking</h6>
                                    <h4 class="text-primary mb-0">${{ "%.2f"|format(student.checking_balance) }}</h4>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                    <h6 class="text-muted mb-2">Savings</h6>
                                    <h4 class="text-success mb-0">${{ "%.2f"|format(student.savings_balance) }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">swap_horiz</span> Transfer Details
                    </div>
                    <div class="card-body">
                        <form method="POST" id="transferDetailsForm">
                            <div class="mb-3">
                                <label for="from_account" class="form-label">From Account</label>
                                <select class="form-select" id="from_account" name="from_account" required>
                                    <option value="checking">Checking</option>
                                    <option value="savings">Savings</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="to_account" class="form-label">To Account</label>
                                <select class="form-select" id="to_account" name="to_account" required>
                                    <option value="savings">Savings</option>
                                    <option value="checking">Checking</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <span class="material-symbols-outlined">check_circle</span> Continue to Confirmation
                            </button>
                        </form>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <span class="material-symbols-outlined">info</span> <strong>Tip:</strong> Your savings account earns
                    {% if settings %}
                        {{ '%.2f'|format(settings.savings_apy) }}% annual {{ calculation_type }} interest
                        {% if calculation_type == 'compound' %}
                            (compounded {{ compound_frequency }})
                        {% endif %}
                    {% else %}
                        4.5% annual simple interest
                    {% endif %}
                    (approximately ${{ '%.2f'|format(forecast_interest) }}/month).
                </div>
            </div>
        </div>
    </div>

    <!-- Send to Student Tab -->
    <div class="tab-pane fade" id="send" role="tabpanel">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="material-symbols-outlined">account_balance_wallet</span> Current Balance
                    </div>
                    <div class="card-body">
                        <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                            <h6 class="text-muted mb-2">Checking</h6>
                            <h4 class="text-primary mb-0">${{ "%.2f"|format(student.checking_balance) }}</h4>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="material-symbols-outlined">send</span> Send Money to Classmate
                    </div>
                    <div class="card-body">
                        <form id="peerTransferForm">
                            <div class="mb-3">
                                <label for="recipient_username" class="form-label">Recipient Username</label>
                                <input type="text" class="form-control" id="recipient_username" name="recipient_username" placeholder="Enter classmate's username" required autocomplete="off">
                                <div class="form-text">Only students in your current class can receive transfers.</div>
                            </div>

                            <div class="mb-3">
                                <label for="peer_amount" class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="peer_amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <span class="material-symbols-outlined">check_circle</span> Continue to Confirmation
                            </button>
                        </form>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <span class="material-symbols-outlined">info</span> <strong>Note:</strong> You can only send money to students in your current class. The money will be sent from your checking account to theirs.
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Tab -->
    <div class="tab-pane fade" id="transactions" role="tabpanel">
        <!-- Nested tabs for Checking vs Savings -->
        <ul class="nav nav-pills mb-3" id="transactionTypeTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checking-history-tab" data-bs-toggle="tab" data-bs-target="#checking-history" type="button" role="tab">
                    <span class="material-symbols-outlined">account_balance_wallet</span> Checking
                    <span class="badge bg-secondary">{% if checking_transactions %}{{ checking_transactions|length }}{% else %}0{% endif %}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="savings-history-tab" data-bs-toggle="tab" data-bs-target="#savings-history" type="button" role="tab">
                    <span class="material-symbols-outlined">savings</span> Savings
                    <span class="badge bg-secondary">{% if savings_transactions %}{{ savings_transactions|length }}{% else %}0{% endif %}</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="transactionTypeTabContent">
            <!-- Checking Transactions -->
            <div class="tab-pane fade show active" id="checking-history" role="tabpanel">
                {% if checking_transactions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in checking_transactions[:50] %}
                                <tr {% if tx.is_void %}class="table-secondary text-decoration-line-through"{% endif %}>
                                    <td>{{ tx.timestamp.strftime('%m/%d/%y %I:%M %p') if tx.timestamp else 'N/A' }}</td>
                                    <td><span class="badge bg-info">{{ tx.type|title if tx.type else 'General' }}</span></td>
                                    <td class="{% if tx.amount < 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
                                        ${{ "%.2f"|format(tx.amount) }}
                                    </td>
                                    <td>{{ tx.description or 'N/A' }}</td>
                                    <td>
                                        {% if tx.is_void %}
                                            <span class="badge bg-secondary">Voided</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if checking_transactions|length > 50 %}
                        <p class="text-muted text-center">Showing most recent 50 transactions</p>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        <span class="material-symbols-outlined">info</span> No checking transactions yet.
                    </div>
                {% endif %}
            </div>

            <!-- Savings Transactions -->
            <div class="tab-pane fade" id="savings-history" role="tabpanel">
                {% if savings_transactions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in savings_transactions[:50] %}
                                <tr {% if tx.is_void %}class="table-secondary text-decoration-line-through"{% endif %}>
                                    <td>{{ tx.timestamp.strftime('%m/%d/%y %I:%M %p') if tx.timestamp else 'N/A' }}</td>
                                    <td><span class="badge bg-info">{{ tx.type|title if tx.type else 'General' }}</span></td>
                                    <td class="{% if tx.amount < 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
                                        ${{ "%.2f"|format(tx.amount) }}
                                    </td>
                                    <td>{{ tx.description or 'N/A' }}</td>
                                    <td>
                                        {% if tx.is_void %}
                                            <span class="badge bg-secondary">Voided</span>
                                        {% else %}
                                            <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if savings_transactions|length > 50 %}
                        <p class="text-muted text-center">Showing most recent 50 transactions</p>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        <span class="material-symbols-outlined">info</span> No savings transactions yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Passphrase Modal -->
<div class="modal fade" id="passphraseModal" tabindex="-1" aria-labelledby="passphraseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="passphraseForm" method="POST" action="{{ url_for('student.transfer') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="passphraseModalLabel">Confirm Transfer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Transfer Details:</strong>
                        <div class="mt-2">
                            <span id="transfer-summary"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="passphrase" class="form-label">Enter your passphrase to confirm:</label>
                        <input type="password" class="form-control" name="passphrase" id="passphrase" autocomplete="current-password" required autofocus>
                    </div>
                    <input type="hidden" name="from_account" id="modal_from_account">
                    <input type="hidden" name="to_account" id="modal_to_account">
                    <input type="hidden" name="amount" id="modal_amount">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Transfer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Peer Transfer Passphrase Modal -->
<div class="modal fade" id="peerPassphraseModal" tabindex="-1" aria-labelledby="peerPassphraseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="peerPassphraseForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="peerPassphraseModalLabel">Confirm Transfer to Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Transfer Details:</strong>
                        <div class="mt-2">
                            <span id="peer-transfer-summary"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="peer_passphrase" class="form-label">Enter your passphrase to confirm:</label>
                        <input type="password" class="form-control" name="passphrase" id="peer_passphrase" autocomplete="current-password" required autofocus>
                    </div>
                    <input type="hidden" name="recipient_username" id="modal_recipient_username">
                    <input type="hidden" name="amount" id="modal_peer_amount">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Transfer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Account-to-account transfer
    document.getElementById("transferDetailsForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const fromAccount = document.getElementById("from_account").value;
        const toAccount = document.getElementById("to_account").value;
        const amount = parseFloat(document.getElementById("amount").value).toFixed(2);

        // Update modal with transfer details
        document.getElementById("modal_from_account").value = fromAccount;
        document.getElementById("modal_to_account").value = toAccount;
        document.getElementById("modal_amount").value = amount;

        const fromText = fromAccount.charAt(0).toUpperCase() + fromAccount.slice(1);
        const toText = toAccount.charAt(0).toUpperCase() + toAccount.slice(1);
        document.getElementById("transfer-summary").innerHTML =
            `Transfer <strong>$${amount}</strong> from <strong>${fromText}</strong> to <strong>${toText}</strong>`;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('passphraseModal'));
        modal.show();

        // Focus on passphrase input when modal is shown
        document.getElementById('passphraseModal').addEventListener('shown.bs.modal', function () {
            document.getElementById('passphrase').focus();
        });
    });

    // Peer-to-peer transfer
    document.getElementById("peerTransferForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const recipientUsername = document.getElementById("recipient_username").value;
        const amount = parseFloat(document.getElementById("peer_amount").value).toFixed(2);

        // Update modal with transfer details
        document.getElementById("modal_recipient_username").value = recipientUsername;
        document.getElementById("modal_peer_amount").value = amount;

        document.getElementById("peer-transfer-summary").innerHTML =
            `Send <strong>$${amount}</strong> to <strong>${recipientUsername}</strong>`;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('peerPassphraseModal'));
        modal.show();

        // Focus on passphrase input when modal is shown
        document.getElementById('peerPassphraseModal').addEventListener('shown.bs.modal', function () {
            document.getElementById('peer_passphrase').focus();
        });
    });

    // Handle peer transfer passphrase form submission
    document.getElementById("peerPassphraseForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

        try {
            const response = await fetch("{{ url_for('student.transfer_to_student') }}", {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('peerPassphraseModal')).hide();
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <span class="material-symbols-outlined">check_circle</span>
                    <strong>Success!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.nav-tabs'));
                
                // Clear form
                document.getElementById("peerTransferForm").reset();
                
                // Reload page after short delay to update balances
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                // Show error message
                alert(data.message || 'Transfer failed. Please try again.');
            }
        } catch (error) {
            console.error('Transfer error:', error);
            alert('An error occurred. Please try again.');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        }
    });
</script>
{% endblock %}
