{% extends "layout_admin.html" %}

{% block page_title %}Student Support Ticket Details: Issue #{{ issue.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Button -->
    <a href="{{ url_for('admin.issues_queue') }}" class="btn btn-outline-secondary mb-3">
        <i class="bi bi-arrow-left me-2"></i>Back to Issues Queue
    </a>

    <div class="row">
        <div class="col-lg-8">
            <!-- Issue Details Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Student Submission
                        </h5>
                        <span class="badge
                            {% if issue.status == 'submitted' or issue.status == 'teacher_review' %}bg-warning text-dark
                            {% elif issue.status == 'teacher_resolved' %}bg-success
                            {% elif issue.status == 'elevated' or issue.status == 'developer_review' %}bg-info
                            {% elif issue.status == 'developer_resolved' %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {{ issue.status|replace('_', ' ')|title }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Student Info -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Student</h6>
                        <p class="mb-0">
                            <i class="bi bi-person-fill me-2"></i>
                            <strong>{{ issue.student_first_name }} {{ issue.student_last_initial }}.</strong>
                            {% if issue.class_label %}
                            <span class="text-muted">| {{ issue.class_label }}</span>
                            {% endif %}
                        </p>
                    </div>

                    <hr>

                    <!-- Category -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Category</h6>
                        <span class="badge bg-secondary">{{ issue.category.name }}</span>
                        <span class="badge bg-light text-dark ms-2">{{ issue.issue_type|title }}</span>
                    </div>

                    <hr>

                    <!-- Student Explanation -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Student's Explanation</h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">{{ issue.student_explanation }}</p>
                        </div>
                    </div>

                    {% if issue.student_expected_outcome %}
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Expected Outcome</h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">{{ issue.student_expected_outcome }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- Timestamps -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">Submitted</h6>
                            <p class="mb-0">
                                <i class="bi bi-clock me-2"></i>
                                <span class="local-timestamp" data-timestamp="{{ format_utc_iso(issue.submitted_at) }}"></span>
                            </p>
                        </div>
                        {% if issue.teacher_reviewed_at %}
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-2">First Reviewed</h6>
                            <p class="mb-0">
                                <i class="bi bi-eye me-2"></i>
                                <span class="local-timestamp" data-timestamp="{{ format_utc_iso(issue.teacher_reviewed_at) }}"></span>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Related Transaction (if applicable) -->
            {% if issue.related_transaction_id %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>Related Transaction
                    </h5>
                </div>
                <div class="card-body">
                    {% if issue.context_snapshot and issue.context_snapshot.transaction %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Transaction ID</h6>
                            <p class="mb-0"><strong>#{{ issue.context_snapshot.transaction.id }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Amount</h6>
                            <p class="mb-0">
                                <strong class="{% if issue.context_snapshot.transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ "%.2f"|format(issue.context_snapshot.transaction.amount) }}
                                </strong>
                            </p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Description</h6>
                            <p class="mb-0">{{ issue.context_snapshot.transaction.description }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Account Type</h6>
                            <p class="mb-0">{{ issue.context_snapshot.transaction.account_type|title }}</p>
                        </div>
                    </div>
                    {% if issue.context_snapshot.transaction.is_void %}
                    <div class="alert alert-danger mt-3 mb-0">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>This transaction has been voided</strong>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted mb-0">Transaction details not available</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Context Snapshot -->
            {% if issue.context_snapshot %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>System Context
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Balances at time of submission -->
                    {% if issue.context_snapshot.balances %}
                    <h6 class="text-muted mb-2">Balances at Time of Submission</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted d-block">Checking</small>
                                <strong>${{ "%.2f"|format(issue.context_snapshot.balances.checking) }}</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted d-block">Savings</small>
                                <strong>${{ "%.2f"|format(issue.context_snapshot.balances.savings) }}</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted d-block">Total</small>
                                <strong>${{ "%.2f"|format(issue.context_snapshot.balances.total) }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Recent Transactions -->
                    {% if issue.context_snapshot.recent_transactions %}
                    <h6 class="text-muted mb-2">Recent Transaction History</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for txn in issue.context_snapshot.recent_transactions[:5] %}
                                <tr {% if txn.id == issue.related_transaction_id %}class="table-warning"{% endif %}>
                                    <td>#{{ txn.id }}</td>
                                    <td class="{% if txn.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                        ${{ "%.2f"|format(txn.amount) }}
                                    </td>
                                    <td>{{ txn.description }}</td>
                                    <td><small>{{ txn.timestamp[:10] if txn.timestamp else 'N/A' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Resolution Actions History -->
            {% if issue.resolution_actions.count() > 0 %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>Resolution Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for action in issue.resolution_actions %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ action.action_type|replace('_', ' ')|title }}</h6>
                                    {% if action.action_description %}
                                    <p class="mb-1 text-muted small">{{ action.action_description }}</p>
                                    {% endif %}
                                    <small class="text-muted">
                                        By {{ action.performed_by_type|title }} at
                                        <span class="local-timestamp" data-timestamp="{{ format_utc_iso(action.created_at) }}"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Action Panel -->
            {% if issue.status in ['submitted', 'teacher_review'] %}
            <div class="card shadow-sm mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-tools me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">Choose how to handle this issue:</p>

                    <!-- Resolve Form -->
                    <form method="POST" action="{{ url_for('admin.resolve_issue', issue_id=issue.id) }}" id="resolveForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Resolution Action</label>
                            <select class="form-select" name="action_type" id="actionType" required>
                                <option value="">Select an action...</option>
                                {% if issue.related_transaction_id %}
                                <option value="reverse_transaction">Reverse/Void Transaction</option>
                                {% endif %}
                                <option value="manual_adjustment">Manual Adjustment (I'll handle it)</option>
                                <option value="deny_issue">Deny Issue</option>
                            </select>
                        </div>

                        <div class="mb-3" id="denialReasonDiv" style="display: none;">
                            <label class="form-label">Denial Reason</label>
                            <textarea class="form-control" name="denial_reason" rows="2" placeholder="Why are you denying this issue?"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notes (optional)</label>
                            <textarea class="form-control" name="teacher_notes" rows="3" placeholder="Internal notes about your resolution"></textarea>
                        </div>

                        <button type="submit" class="btn btn-success w-100 mb-2">
                            <i class="bi bi-check-circle me-2"></i>Resolve Issue
                        </button>
                    </form>

                    <hr>

                    <!-- Escalate Button -->
                    <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#escalateModal">
                        <i class="bi bi-arrow-up-circle me-2"></i>Escalate to Developer
                    </button>
                </div>
            </div>
            {% elif issue.status == 'teacher_resolved' %}
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Resolved
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Resolution:</strong> {{ issue.teacher_resolution }}</p>
                    {% if issue.teacher_notes %}
                    <p class="mb-2"><strong>Notes:</strong></p>
                    <div class="bg-light p-2 rounded">
                        <p class="mb-0 small">{{ issue.teacher_notes }}</p>
                    </div>
                    {% endif %}
                    <p class="text-muted small mb-0 mt-2">
                        Resolved <span class="local-timestamp" data-timestamp="{{ format_utc_iso(issue.teacher_resolved_at) }}"></span>
                    </p>
                </div>
            </div>
            {% elif issue.status == 'developer_resolved' %}
            <div class="card shadow-sm mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Resolved by Developer
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Original Escalation Reason:</strong> {{ issue.escalation_reason }}</p>
                    {% if issue.sysadmin_notes %}
                    <p class="mb-2"><strong>Developer Notes:</strong></p>
                    <div class="bg-light p-2 rounded">
                        <p class="mb-0 small">{{ issue.sysadmin_notes }}</p>
                    </div>
                    {% endif %}
                    {% if issue.teacher_diagnostic_note %}
                    <p class="mb-2"><strong>Your Diagnostic Notes:</strong></p>
                    <div class="bg-light p-2 rounded">
                        <p class="mb-0 small">{{ issue.teacher_diagnostic_note }}</p>
                    </div>
                    {% endif %}
                    {% if issue.eligible_for_reward %}
                    <div class="alert alert-success mt-3 mb-0">
                        <i class="bi bi-gift-fill me-2"></i>
                        <strong>Student was marked eligible for bug reward</strong>
                    </div>
                    {% endif %}
                    <p class="text-muted small mb-0 mt-2">
                        Escalated <span class="local-timestamp" data-timestamp="{{ format_utc_iso(issue.escalated_at) }}"></span>
                        {% if issue.sysadmin_resolved_at %}
                        • Resolved <span class="local-timestamp" data-timestamp="{{ format_utc_iso(issue.sysadmin_resolved_at) }}"></span>
                        {% endif %}
                    </p>
                </div>
            </div>
            {% elif issue.status in ['elevated', 'developer_review'] %}
            <div class="card shadow-sm mb-4 border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0 text-black">
                        <i class="bi bi-arrow-up-circle me-2"></i>Escalated
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>Reason:</strong> {{ issue.escalation_reason }}</p>
                    {% if issue.teacher_diagnostic_note %}
                    <p class="mb-2"><strong>Diagnostic Notes:</strong></p>
                    <div class="bg-light p-2 rounded">
                        <p class="mb-0 small">{{ issue.teacher_diagnostic_note }}</p>
                    </div>
                    {% endif %}
                    {% if issue.eligible_for_reward %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-gift-fill me-2"></i>
                        <strong>Marked as eligible for bug reward</strong>
                    </div>
                    {% endif %}
                    <p class="text-muted small mb-0 mt-2">
                        Escalated <span class="local-timestamp" data-timestamp="{{ format_utc_iso(issue.escalated_at) }}"></span>
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Status History -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Status History
                    </h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for history in issue.status_history %}
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker me-3">
                                    <i class="bi bi-circle-fill text-primary"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ history.new_status|replace('_', ' ')|title }}</div>
                                    <small class="text-muted">
                                        By {{ history.changed_by_type|title }} •
                                        <span class="local-timestamp" data-timestamp="{{ format_utc_iso(history.changed_at) }}"></span>
                                    </small>
                                    {% if history.notes %}
                                    <p class="mb-0 small text-muted mt-1">{{ history.notes }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Escalate Modal -->
<div class="modal fade" id="escalateModal" tabindex="-1" aria-labelledby="escalateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="escalateModalLabel">
                    <i class="bi bi-arrow-up-circle me-2"></i>Escalate to Developer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.escalate_issue', issue_id=issue.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Important:</strong> Escalate only when you cannot resolve the issue with available tools,
                        or when you suspect a system bug or data integrity problem.
                    </div>

                    <div class="mb-3">
                        <label for="escalation_reason" class="form-label fw-bold">
                            Escalation Reason <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" name="escalation_reason" id="escalation_reason" required>
                            <option value="">Select reason...</option>
                            <option value="Suspected Bug">Suspected Bug</option>
                            <option value="Data Integrity Issue">Data Integrity Issue</option>
                            <option value="Cannot Resolve with Available Tools">Cannot Resolve with Available Tools</option>
                            <option value="System Error">System Error</option>
                            <option value="Feature Request">Feature Request</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="diagnostic_note" class="form-label fw-bold">Diagnostic Notes</label>
                        <textarea class="form-control" name="diagnostic_note" id="diagnostic_note" rows="4"
                                  placeholder="What have you tried? What did you observe? Help the developer understand the issue."></textarea>
                        <small class="form-text text-muted">
                            Provide any technical details that might help the developer investigate.
                        </small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="share_class_name" id="share_class_name">
                            <label class="form-check-label" for="share_class_name">
                                Share class name/identifier with developer
                            </label>
                            <small class="d-block text-muted mt-1">
                                By default, only an opaque reference is shared. Check this if the developer needs the class name for investigation.
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="eligible_for_reward" id="eligible_for_reward">
                            <label class="form-check-label fw-bold" for="eligible_for_reward">
                                <i class="bi bi-gift-fill me-1 text-warning"></i>
                                Student may receive rewards if this bug report is legitimate
                            </label>
                            <small class="d-block text-muted mt-1">
                                Check this if you believe the student discovered a genuine bug and should be rewarded.
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-up-circle me-2"></i>Escalate Issue
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Show/hide denial reason field
document.getElementById('actionType').addEventListener('change', function() {
    const denialDiv = document.getElementById('denialReasonDiv');
    if (this.value === 'deny_issue') {
        denialDiv.style.display = 'block';
        denialDiv.querySelector('textarea').required = true;
    } else {
        denialDiv.style.display = 'none';
        denialDiv.querySelector('textarea').required = false;
    }
});
</script>

<style>
.timeline-marker i {
    font-size: 0.5rem;
}
</style>
{% endblock %}
