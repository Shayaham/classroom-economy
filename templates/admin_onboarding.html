{% extends "layout_admin.html" %}
{% set page_title = "Getting Started" %}
{% block title %}Getting Started - Classroom Token Hub{% endblock %}
{% block page_icon %}rocket_launch{% endblock %}

{% block extra_head %}
<style>
    .onboarding-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 10%;
        right: 10%;
        height: 4px;
        background: var(--gray-200);
        z-index: 0;
    }

    .step-item {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-weight: 600;
        color: var(--secondary);
        transition: all 0.3s ease;
    }

    .step-item.active .step-circle {
        background: var(--secondary);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 175, 223, 0.3);
    }

    .step-item.completed .step-circle {
        background: #818181ff;
        color: white;
    }

    .step-label {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .step-item.active .step-label {
        color: var(--brand-primary);
        font-weight: 600;
    }

    .welcome-hero {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: white;
        padding: 3rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 2rem;
    }

    .welcome-hero h1 {
        margin-bottom: 1rem;
        color:white;
    }

    .feature-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }

    .feature-card {
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .feature-card.selected {
        border-color: var(--brand-cyan);
        background: rgba(0, 175, 223, 0.05);
    }

    .feature-card.disabled {
        opacity: 0.7;
        cursor: not-allowed;
        border-color: var(--gray-300);
        background: var(--gray-100);
    }

    .feature-card input[type="checkbox"] {
        display: none;
    }

    .feature-card .check-icon {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .feature-card.selected .check-icon {
        opacity: 1;
    }

    .onboarding-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="onboarding-container">
    <!-- Step Indicator -->
    <div class="step-indicator">
        {% for step in steps %}
        <div class="step-item {% if loop.index == current_step %}active{% elif onboarding.is_step_completed(step.id) %}completed{% endif %}"
             id="step-indicator-{{ step.id }}">
            <div class="step-circle">
                {% if onboarding.is_step_completed(step.id) %}
                    <span class="material-symbols-outlined">check</span>
                {% else %}
                    {{ loop.index }}
                {% endif %}
            </div>
            <div class="step-label">{{ step.title }}</div>
        </div>
        {% endfor %}
    </div>

    <!-- Step 1: Welcome -->
    <div class="step-content {% if current_step == 1 %}active{% endif %}" id="step-welcome">
        <div class="welcome-hero">
            <span class="material-symbols-outlined mb-0" style="font-size: 40pt;color:#D3AF37">local_atmstorefinance_mode</span>
            <hr>
            <h1><span style="font-weight:300">Hello</span>, Teachers!</h1>
            <p class="mb-0 text-start ">
                Thank you for bringing Classroom Token Hub into your classroom.
            </p>
            <p class="mb-0 text-start ">
               To ensure you can start using Classroom Token Hub quickly, we have created this set up wizard to guide you through the key components of your classroom economy. If you need any assistance, you can find tutorials under settings on the left menu bar or submit a support ticket to us.
            </p>
            <p class="mb-0 text-start ">
               We hope you find Classroom Token Hub to be as useful as we have designed it to be. We look forward to hear your feedback and suggestions to make it even better!</p>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <h4 class="mb-1">What is Classroom Token Hub?</h4>
                <p class="mb-4"> We are many things. But at our core, we are a classroom management system that simulates a real-world economy to teach students financial literacy and responsibility. Here are some of the key features:</p>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-primary" style="font-size: 3rem;">payments</span>
                            <h5 class="mt-2">Earn & Save</h5>
                            <p class="text-muted small">Students earn virtual currency through attendance and good behavior. </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-success" style="font-size: 3rem;">storefront</span>
                            <h5 class="mt-2">Spend & Learn</h5>
                            <p class="text-muted small">Create a classroom store where students can spend their earnings.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-warning" style="font-size: 3rem;">account_balance</span>
                            <h5 class="mt-2">Real-World Skills</h5>
                            <p class="text-muted small">Teach financial literacy with banking, insurance, and budgeting.</p>
                        </div>
                    </div>
                </div>
                <p class="mt-2 alert alert-info"> During this set up, if you don't want to set up certain features, you can simply skip them. You can always activate them later in your settings.</p>
                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="skipOnboarding()">
                        Skip Setup
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('welcome')">
                        Let's Get Started
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Roster Upload -->
    <div class="step-content {% if current_step == 2 %}active{% endif %}" id="step-roster">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">upload_file</span>
                    Upload Your Student Roster
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Upload a CSV file with your students. This will automatically create your class periods. Don't worry - you can add more students later!
                </p>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="mb-3">Required Columns:</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        First Name
                                    </li>
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        Last Name
                                    </li>
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        Date of Birth (MM/DD/YYYY)
                                    </li>
                                    <li class="mb-2">
                                        <span class="material-symbols-outlined text-success me-2">check_circle</span>
                                        Period/Block
                                    </li>
                                </ul>
                                <a href="{{ url_for('admin.download_csv_template') }}" class="btn btn-outline-primary">
                                    <span class="material-symbols-outlined me-1" style="vertical-align: middle;">download</span>
                                    Download Template
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 bg-light">
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('admin.upload_students') }}" enctype="multipart/form-data" id="rosterUploadForm">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Upload CSV File:</label>
                                        <input type="file" class="form-control" name="csv_file" accept=".csv" id="rosterFile">
                                    </div>
                                    <button type="submit" class="btn btn-success w-100">
                                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">cloud_upload</span>
                                        Upload Roster
                                    </button>
                                </form>
                                <div class="text-center mt-3">
                                    <small class="text-muted">Or skip this step and add students later</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="mt-2 alert alert-warning">It is very important that you follow the template format exactly to ensure the app can interpret your submissions. Watch out for roster with cutoff names</p>
                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep('roster')">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('roster')">
                        Skip for Now
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Feature Selection -->
    <div class="step-content {% if current_step == 3 %}active{% endif %}" id="step-features">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">tune</span>
                    Choose Your Features
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Select the features you want to use in your classroom economy. You can always enable and set up features later.
                </p>

                <div class="feature-selection-grid">
                    <div class="feature-card selected disabled" title="Payroll is required and cannot be disabled">
                        <input type="checkbox" name="feature_payroll" checked disabled>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">payments</span>
                            <span class="material-symbols-outlined text-success check-icon">lock</span>
                        </div>
                        <h6 class="mt-2 mb-1">Payroll (Required)</h6>
                        <small class="text-muted">Time-based ("clock-in/out") attendance tracking & payment</small>
                    </div>

                    <div class="feature-card selected" onclick="toggleFeature(this, 'store')">
                        <input type="checkbox" name="feature_store" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">storefront</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Store</h6>
                        <small class="text-muted">Classroom marketplace for rewards</small>
                    </div>

                    <div class="feature-card selected" onclick="toggleFeature(this, 'banking')">
                        <input type="checkbox" name="feature_banking" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">account_balance</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Banking</h6>
                        <small class="text-muted">Savings accounts with interest</small>
                    </div>

                    <div class="feature-card" onclick="toggleFeature(this, 'rent')">
                        <input type="checkbox" name="feature_rent">
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">home</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Rent</h6>
                        <small class="text-muted">Monthly desk/seat payments</small>
                    </div>

                    <div class="feature-card" onclick="toggleFeature(this, 'insurance')">
                        <input type="checkbox" name="feature_insurance">
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">shield</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Insurance</h6>
                        <small class="text-muted">Protection policies for students</small>
                    </div>

                    <div class="feature-card selected" onclick="toggleFeature(this, 'hall_pass')">
                        <input type="checkbox" name="feature_hall_pass" checked>
                        <div class="d-flex justify-content-between">
                            <span class="material-symbols-outlined text-primary">confirmation_number</span>
                            <span class="material-symbols-outlined text-success check-icon">check_circle</span>
                        </div>
                        <h6 class="mt-2 mb-1">Hall Pass</h6>
                        <small class="text-muted">Digital bathroom/water passes</small>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">info</span>
                        <div>
                            <p><strong>Why can't I unselect payroll?</strong></p>
                            <p>The key feature of Classroom Token Hub is simulating real-world systems. Payroll feature simulates real-world action of "clocking in / out" for work, which teaches students the importance of punctuality and personal responsibility. It also allows for management of hall passes and attendance.</p>
                        </div>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep('features')">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep('features')">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4+: Dynamic Feature Setup Steps -->
    <!-- These are generated dynamically based on selected features -->

    <!-- Payroll Setup (Always shown - mandatory) -->
    <div class="step-content feature-setup-step" data-feature-step="payroll" id="step-setup-payroll" style="display: none;">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">payments</span>
                    Set Up Payroll (CWI System)
                </h5>
            </div>
            <div class="card-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup-content" type="button" role="tab">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">settings</span>
                            Setup
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cwi-tab" data-bs-toggle="tab" data-bs-target="#cwi-content" type="button" role="tab">
                            <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">school</span>
                            What is CWI?
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Setup Tab -->
                    <div class="tab-pane fade show active" id="setup-content" role="tabpanel">
                        <div class="alert alert-info mb-4">
                            <div class="d-flex align-items-start gap-3">
                                <span class="material-symbols-outlined">info</span>
                                <div>
                                    <strong>Quick Tip:</strong> CWI (Classroom Wage Index) is your economy's foundation. Choose a pay rate and let the app calculate it for you, or customize every detail in Advanced mode.
                                </div>
                            </div>
                        </div>

                        <!-- Mode Toggle -->
                <div class="btn-group w-100 mb-4" role="group">
                    <input type="radio" class="btn-check" name="payrollMode" id="payrollModeBasic" checked onclick="togglePayrollMode('basic')">
                    <label class="btn btn-outline-primary" for="payrollModeBasic">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">bolt</span>
                        Basic Setup
                    </label>

                    <input type="radio" class="btn-check" name="payrollMode" id="payrollModeAdvanced" onclick="togglePayrollMode('advanced')">
                    <label class="btn btn-outline-primary" for="payrollModeAdvanced">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">settings_suggest</span>
                        Advanced Setup
                    </label>
                </div>

                <!-- Basic Mode -->
                <div id="payrollBasicMode">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                Pay Rate (per hour)
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="How much students earn per hour of attendance. This determines your classroom's CWI.">help</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" value="15" step="0.25" min="0" id="payRate" oninput="updateCWIEstimate()">
                            </div>
                            <small class="text-muted">Recommended: $10-$20 per hour</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                Pay Frequency
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="How often students receive their paycheck. Bi-weekly (every 2 weeks) is most common.">help</span>
                            </label>
                            <select class="form-select" id="payFrequency">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly" selected>Bi-weekly (Recommended)</option>
                                <option value="monthly">Monthly</option>
                            </select>
                            <small class="text-muted">Mimics real-world pay schedules</small>
                        </div>
                    </div>

                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                First Pay Date
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Date of the first payroll run. Subsequent paychecks will follow your chosen frequency.">help</span>
                            </label>
                            <input type="date" class="form-control" id="firstPayDate">
                            <small class="text-muted">Date of first paycheck</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                Daily Time Limit (optional)
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Maximum hours a student can earn per day. Auto-tap-out when reached. Leave blank for no limit.">help</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" placeholder="8.0" step="0.5" min="0" id="dailyLimit">
                                <span class="input-group-text">hrs/day</span>
                            </div>
                            <small class="text-muted">Prevents over-earning</small>
                        </div>
                    </div>

                    <div class="alert alert-secondary mt-3">
                        <div class="d-flex align-items-start gap-2">
                            <span class="material-symbols-outlined" style="font-size: 18px;">calculate</span>
                            <div>
                                <small><strong>Your estimated CWI:</strong> $<span id="cwiEstimate">300</span>/week (based on 5 days × 4 hours/day × $15/hour)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Mode (Hidden by default) -->
                <div id="payrollAdvancedMode" style="display: none;">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                Hourly Rate
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Base pay per hour of class attendance">help</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" value="15" step="0.25" min="0" id="payRateAdv" oninput="updateCWIEstimateAdv()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                Expected Weekly Hours
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Total hours per week a student typically attends your class (e.g., 5 days × 4 hours = 20)">help</span>
                            </label>
                            <input type="number" class="form-control" value="20" step="1" min="1" id="weeklyHours" oninput="updateCWIEstimateAdv()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                Pay Frequency
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="How often paychecks are distributed">help</span>
                            </label>
                            <select class="form-select" id="payFrequencyAdv">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly" selected>Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                First Pay Date
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Date of the first payroll run">help</span>
                            </label>
                            <input type="date" class="form-control" id="firstPayDateAdv">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                Daily Time Limit (optional)
                                <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Maximum hours per day. Auto-tap-out when reached.">help</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" placeholder="8.0" step="0.5" min="0" id="dailyLimitAdv">
                                <span class="input-group-text">hrs/day</span>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-secondary mt-3">
                        <div class="d-flex align-items-start gap-2">
                            <span class="material-symbols-outlined" style="font-size: 18px;">calculate</span>
                            <div>
                                <small><strong>Your CWI:</strong> $<span id="cwiEstimateAdv">300</span>/week</small><br>
                                <small class="text-muted">This becomes your economy's baseline for all pricing</small>
                            </div>
                        </div>
                    </div>
                </div>
                    </div> <!-- End Setup Tab -->

                    <!-- CWI Education Tab -->
                    <div class="tab-pane fade" id="cwi-content" role="tabpanel">
                        <h6 class="mb-3">
                            <span class="material-symbols-outlined me-2" style="vertical-align: middle;">info</span>
                            Understanding CWI (Classroom Wage Index)
                        </h6>

                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <span class="material-symbols-outlined me-1" style="vertical-align: middle; font-size: 20px;">calculate</span>
                                    What is CWI?
                                </h6>
                                <p class="card-text mb-0">
                                    <strong>CWI</strong> is the expected <em>weekly total pay</em> for a student who attends all of your class sessions. It's calculated automatically based on:
                                </p>
                                <p class="mb-0 mt-2"><code>CWI = Hourly Rate × Expected Weekly Hours</code></p>
                            </div>
                        </div>

                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <span class="material-symbols-outlined me-1" style="vertical-align: middle; font-size: 20px;">balance</span>
                                    Why is CWI Important?
                                </h6>
                                <p class="card-text">
                                    CWI becomes the <strong>foundation of your entire classroom economy</strong>. All prices are automatically calculated as proportions of CWI to keep your economy balanced:
                                </p>
                                <ul class="mb-0">
                                    <li><strong>Rent:</strong> 2.0–2.5× CWI (typically ~30-40% of monthly income)</li>
                                    <li><strong>Store Items (Basic):</strong> 0.02–0.05× CWI (small rewards)</li>
                                    <li><strong>Store Items (Premium):</strong> 0.10–0.25× CWI (valuable rewards)</li>
                                    <li><strong>Fines:</strong> 0.05–0.15× CWI (meaningful but not crushing)</li>
                                    <li><strong>Insurance Premiums:</strong> 0.05–0.12× CWI (affordable protection)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <span class="material-symbols-outlined me-1" style="vertical-align: middle; font-size: 20px;">lightbulb</span>
                                    Real-World Example
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="p-3 border rounded">
                                            <p class="mb-2"><strong>Your Settings:</strong></p>
                                            <ul class="mb-0 small">
                                                <li>Pay Rate: $15/hour</li>
                                                <li>Class meets: 5 days/week, 4 hours/day</li>
                                                <li>Weekly Hours: 20 hours</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 border rounded bg-white">
                                            <p class="mb-2"><strong>Your Economy:</strong></p>
                                            <ul class="mb-0 small">
                                                <li><strong>CWI:</strong> $300/week</li>
                                                <li><strong>Monthly Rent:</strong> ~$675 (2.25× CWI)</li>
                                                <li><strong>Basic Store Item:</strong> ~$12 (0.04× CWI)</li>
                                                <li><strong>Premium Item:</strong> ~$60 (0.20× CWI)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-success">
                            <div class="d-flex align-items-start gap-2">
                                <span class="material-symbols-outlined">check_circle</span>
                                <div>
                                    <strong>The Bottom Line:</strong> By setting your pay rate, you're automatically creating a balanced economy where everything is proportional to student earnings. No complex calculations needed!
                                </div>
                            </div>
                        </div>
                    </div> <!-- End CWI Tab -->
                </div> <!-- End Tab Content -->

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevFeatureStep()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextFeatureStep()">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Setup (Conditional) -->
    <div class="step-content feature-setup-step" data-feature-step="store" id="step-setup-store" style="display: none;">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">storefront</span>
                    Set Up Store
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">lightbulb</span>
                        <div>
                            <strong>Tip:</strong> Start with a few simple reward items. You can always add more later! Popular items include homework passes, extra credit, or special privileges.
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Create Your First Store Item</label>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="Item name (e.g., Homework Pass)" id="storeItemName">
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" placeholder="Price" id="storeItemPrice" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" placeholder="Stock" id="storeItemStock" min="1" value="10">
                        </div>
                    </div>
                    <small class="text-muted">Don't worry - you can skip this and add items later from your dashboard</small>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevFeatureStep()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextFeatureStep()">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Banking Setup (Conditional) -->
    <div class="step-content feature-setup-step" data-feature-step="banking" id="step-setup-banking" style="display: none;">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">account_balance</span>
                    Set Up Banking
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">savings</span>
                        <div>
                            <strong>Tip:</strong> Interest rates teach students about compound growth. A 5-10% rate is realistic while showing meaningful results over time.
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Savings Interest Rate (APY)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="5" step="0.5" min="0" max="100" id="interestRate">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Annual percentage yield for savings accounts</small>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="overdraftProtection">
                            <label class="form-check-label" for="overdraftProtection">
                                <strong>Enable overdraft protection</strong>
                            </label>
                        </div>
                        <small class="text-muted">Prevents negative balances</small>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevFeatureStep()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextFeatureStep()">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rent Setup (Conditional) -->
    <div class="step-content feature-setup-step" data-feature-step="rent" id="step-setup-rent" style="display: none;">
        <div class="card shadow">
            <div class="card-header bg-warning">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">home</span>
                    Set Up Rent
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">home_work</span>
                        <div>
                            <strong>Tip:</strong> Rent teaches budgeting and recurring expenses. Set it to about 30-40% of typical monthly earnings to mirror real-world proportions.
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Monthly Rent Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" value="50" step="5" min="0" id="rentAmount">
                        </div>
                        <small class="text-muted">Amount charged per desk/seat each month</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Due Date</label>
                        <select class="form-select" id="rentDueDate">
                            <option value="1" selected>1st of the month</option>
                            <option value="15">15th of the month</option>
                            <option value="last">Last day of month</option>
                        </select>
                        <small class="text-muted">When rent is collected</small>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevFeatureStep()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextFeatureStep()">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Insurance Setup (Conditional) -->
    <div class="step-content feature-setup-step" data-feature-step="insurance" id="step-setup-insurance" style="display: none;">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">shield</span>
                    Set Up Insurance
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">health_and_safety</span>
                        <div>
                            <strong>Tip:</strong> Insurance teaches risk management. Students pay small premiums but can be reimbursed for fines or emergencies.
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Basic Premium (per period)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" value="10" step="1" min="0" id="insurancePremium">
                        </div>
                        <small class="text-muted">Regular payment for coverage</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Coverage Percentage</label>
                        <div class="input-group">
                            <input type="number" class="form-control" value="80" step="5" min="0" max="100" id="insuranceCoverage">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">How much of claims are reimbursed</small>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevFeatureStep()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextFeatureStep()">
                        Continue
                        <span class="material-symbols-outlined ms-1" style="vertical-align: middle;">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hall Pass Setup (Conditional) -->
    <div class="step-content feature-setup-step" data-feature-step="hall_pass" id="step-setup-hall_pass" style="display: none;">
        <div class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2" style="vertical-align: middle;">confirmation_number</span>
                    Set Up Hall Passes
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <div class="d-flex align-items-start gap-3">
                        <span class="material-symbols-outlined">info</span>
                        <div>
                            <strong>Tip:</strong> The queue system helps you manage how many students can be out of class at once. Students request passes, you approve them, and they join the queue.
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="queueEnabled" checked style="width: 3em; height: 1.5em; cursor: pointer;">
                            <label class="form-check-label fw-bold" for="queueEnabled" style="cursor: pointer;">
                                Enable Queue System
                            </label>
                        </div>
                        <small class="text-muted">Students must request approval before leaving class</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Queue Limit
                            <span class="material-symbols-outlined text-muted" style="font-size: 16px; cursor: help;" title="Maximum number of students allowed out of class at the same time">help</span>
                        </label>
                        <input type="number" class="form-control" value="10" step="1" min="1" max="50" id="queueLimit">
                        <small class="text-muted">Max students out at once (1-50)</small>
                    </div>
                </div>

                <div class="onboarding-nav">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevFeatureStep()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">arrow_back</span>
                        Back
                    </button>
                    <button type="button" class="btn btn-success btn-lg" onclick="completeOnboarding()">
                        <span class="material-symbols-outlined me-1" style="vertical-align: middle;">check_circle</span>
                        Complete Setup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
const csrfToken = csrfTokenMeta ? csrfTokenMeta.content : '';
const stepOrder = ['welcome', 'roster', 'features', 'settings'];
let currentStepIndex = {{ current_step - 1 }};

function toggleFeature(card, feature) {
    // Don't allow toggling payroll (it's mandatory)
    if (feature === 'payroll') {
        return;
    }

    card.classList.toggle('selected');
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
}

function getSelectedFeatures() {
    const features = {};
    document.querySelectorAll('.feature-card input[type="checkbox"]').forEach(cb => {
        const feature = cb.name.replace('feature_', '');
        features[feature] = cb.checked;
    });
    // Ensure payroll is always true
    features.payroll = true;
    return features;
}

function showStep(stepId) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(step => {
        step.classList.remove('active');
    });

    // Show selected step
    document.getElementById('step-' + stepId).classList.add('active');

    // Note: 'settings' step is now handled by dynamic feature setup pages
    // No longer need updateFeatureSettings() here

    // Update indicators
    stepOrder.forEach((step, index) => {
        const indicator = document.getElementById('step-indicator-' + step);
        indicator.classList.remove('active', 'completed');

        if (index < currentStepIndex) {
            indicator.classList.add('completed');
        } else if (index === currentStepIndex) {
            indicator.classList.add('active');
        }
    });
}

// updateFeatureSettings() - REMOVED
// This function was part of the old single-page settings layout
// Now using dynamic multi-page feature setup with buildFeatureSteps() and showFeatureStep()

function nextStep(currentStep) {
    const stepData = {};

    if (currentStep === 'features') {
        stepData.features = getSelectedFeatures();
    }

    fetch('/admin/onboarding/step/' + currentStep, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(stepData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Special handling for features step - go to feature setup flow
            if (currentStep === 'features') {
                // Build and show feature setup steps
                buildFeatureSteps();
                showFeatureStep(0); // Start with first feature (payroll)
            } else {
                currentStepIndex = data.next_step - 1;
                if (data.is_completed) {
                    window.location.href = '/admin';
                } else {
                    showStep(stepOrder[currentStepIndex]);
                }
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Still advance step on error for better UX
        if (currentStep === 'features') {
            buildFeatureSteps();
            showFeatureStep(0);
        } else if (currentStepIndex < stepOrder.length - 1) {
            currentStepIndex++;
            showStep(stepOrder[currentStepIndex]);
        }
    });
}

function prevStep(currentStep) {
    if (currentStepIndex > 0) {
        currentStepIndex--;
        showStep(stepOrder[currentStepIndex]);
    }
}

function skipOnboarding() {
    if (confirm('Are you sure you want to skip the setup? You can configure settings later from the dashboard.')) {
        fetch('/admin/onboarding/skip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = data.redirect;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            window.location.href = '/admin';
        });
    }
}

// Dynamic feature step navigation
let featureSteps = [];
let currentFeatureStepIndex = 0;

function buildFeatureSteps() {
    // Build list of feature setup steps based on selected features
    const selectedFeatures = getSelectedFeatures();
    featureSteps = ['payroll']; // Payroll is always first

    // Add other features in order
    const featureOrder = ['store', 'banking', 'rent', 'insurance', 'hall_pass'];
    featureOrder.forEach(feature => {
        if (selectedFeatures[feature]) {
            featureSteps.push(feature);
        }
    });

    currentFeatureStepIndex = 0;
}

function showFeatureStep(featureIndex) {
    // Hide all feature setup steps
    document.querySelectorAll('.feature-setup-step').forEach(step => {
        step.classList.remove('active');
        step.style.display = 'none';
    });

    // Show the current feature step
    const featureName = featureSteps[featureIndex];
    const stepEl = document.getElementById('step-setup-' + featureName);
    if (stepEl) {
        stepEl.classList.add('active');
        stepEl.style.display = 'block';
    }
}

function nextFeatureStep() {
    if (currentFeatureStepIndex < featureSteps.length - 1) {
        currentFeatureStepIndex++;
        showFeatureStep(currentFeatureStepIndex);
    } else {
        // Last feature step completed
        completeOnboarding();
    }
}

function prevFeatureStep() {
    if (currentFeatureStepIndex > 0) {
        currentFeatureStepIndex--;
        showFeatureStep(currentFeatureStepIndex);
    } else {
        // Go back to feature selection
        document.querySelectorAll('.feature-setup-step').forEach(step => {
            step.classList.remove('active');
            step.style.display = 'none';
        });
        currentStepIndex = 2; // features step
        showStep(stepOrder[currentStepIndex]);
    }
}

function togglePayrollMode(mode) {
    const basicMode = document.getElementById('payrollBasicMode');
    const advancedMode = document.getElementById('payrollAdvancedMode');

    if (mode === 'basic') {
        basicMode.style.display = 'block';
        advancedMode.style.display = 'none';
    } else {
        basicMode.style.display = 'none';
        advancedMode.style.display = 'block';
        updateCWIEstimateAdv(); // Update CWI when switching to advanced
    }
}

// CWI Calculator for Basic Mode
function updateCWIEstimate() {
    const payRate = parseFloat(document.getElementById('payRate').value) || 15;
    // Assume 5 days/week × 4 hours/day = 20 hours/week as default
    const weeklyHours = 20;
    const cwi = payRate * weeklyHours;
    document.getElementById('cwiEstimate').textContent = cwi.toFixed(0);
}

// CWI Calculator for Advanced Mode
function updateCWIEstimateAdv() {
    const payRate = parseFloat(document.getElementById('payRateAdv').value) || 15;
    const weeklyHours = parseFloat(document.getElementById('weeklyHours').value) || 20;
    const cwi = payRate * weeklyHours;
    document.getElementById('cwiEstimateAdv').textContent = cwi.toFixed(0);
}

// Initialize CWI estimates on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCWIEstimate();
    updateCWIEstimateAdv();
});

function completeOnboarding() {
    // Save quick settings first - check which payroll mode is active
    const isBasicMode = document.getElementById('payrollModeBasic').checked;
    const payRate = isBasicMode ? document.getElementById('payRate').value : document.getElementById('payRateAdv').value;
    const payFrequency = isBasicMode ? document.getElementById('payFrequency').value : document.getElementById('payFrequencyAdv').value;
    const interestRate = document.getElementById('interestRate') ? document.getElementById('interestRate').value : null;
    const overdraftProtection = document.getElementById('overdraftProtection') ? document.getElementById('overdraftProtection').checked : null;

    // Complete onboarding
    fetch('/admin/onboarding/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            payRate: payRate,
            payFrequency: payFrequency,
            interestRate: interestRate,
            overdraftProtection: overdraftProtection
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.href = data.redirect;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.location.href = '/admin';
    });
}
</script>
{% endblock %}
