{% extends "base.html" %}
{% set full_width = true %}
{% set show_sysadmin_link = false %}

{% block title %}{{ title }} - Documentation{% endblock %}


<!-- Documentation-specific styles and scripts -->



{% block content %}
<div class="docs-layout">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <aside class="docs-sidebar col-md-3 col-lg-2 d-md-block bg-light collapse" id="docsSidebar">
                <div class="position-sticky pt-3">
                    <!-- Back Navigation -->
                    <div class="mb-3">
                        {% if session.get('student_id') %}
                            <a href="{{ url_for('student.dashboard') }}" class="btn btn-sm btn-primary w-100">
                                <span class="material-symbols-outlined icon-align">arrow_back</span>
                                Back to Dashboard
                            </a>
                        {% elif session.get('is_admin') and session.get('admin_id') %}
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-sm btn-primary w-100">
                                <span class="material-symbols-outlined icon-align">arrow_back</span>
                                Back to Dashboard
                            </a>
                        {% elif session.get('is_system_admin') and session.get('sysadmin_id') %}
                            <a href="{{ url_for('sysadmin.dashboard') }}" class="btn btn-sm btn-primary w-100">
                                <span class="material-symbols-outlined icon-align">arrow_back</span>
                                Back to Dashboard
                            </a>
                        {% endif %}
                    </div>

                    <!-- Docs Home (always show) -->
                    <div class="mb-3">
                        <a href="{{ url_for('docs.index') }}" class="btn btn-sm {% if session.get('student_id') or session.get('is_admin') or session.get('is_system_admin') %}btn-outline-secondary{% else %}btn-primary{% endif %} w-100">
                            <span class="material-symbols-outlined icon-align">home</span>
                            Docs Home
                        </a>
                    </div>

                    <!-- Search -->
                    <form action="{{ url_for('docs.search') }}" method="get" class="mb-3">
                        <div class="input-group input-group-sm">
                            <input type="search" name="q" class="form-control" placeholder="Search..." aria-label="Search">
                            <button class="btn btn-outline-secondary" type="submit">
                                <span class="material-symbols-outlined icon-small">search</span>
                            </button>
                        </div>
                    </form>

                    <!-- Navigation Accordion -->
                    <div class="accordion accordion-flush" id="docsAccordion">
                        <!-- Diagnostics / User Guides -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button {% if not doc_path.startswith('diagnostics') %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#diagnosticsCollapse" aria-expanded="{% if doc_path.startswith('diagnostics') %}true{% else %}false{% endif %}">
                                    <span class="material-symbols-outlined me-2">quick_reference</span>
                                    Diagnostics
                                </button>
                            </h2>
                            <div id="diagnosticsCollapse" class="accordion-collapse collapse {% if doc_path.startswith('diagnostics') %}show{% endif %}">
                                <div class="accordion-body p-0">
                                    <ul class="nav flex-column">
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path.startswith('diagnostics/student') %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='diagnostics/student') }}">
                                                <span class="material-symbols-outlined me-2" style="font-size: 1rem;">school</span>
                                                For Students
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path.startswith('diagnostics/teacher') %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='diagnostics/teacher') }}">
                                                <span class="material-symbols-outlined me-2" style="font-size: 1rem;">person</span>
                                                For Teachers
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Feature Guides -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button {% if not (doc_path.startswith('features') or doc_path == 'user-guides/economy_guide') %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#featuresCollapse" aria-expanded="{% if doc_path.startswith('features') or doc_path == 'user-guides/economy_guide' %}true{% else %}false{% endif %}">
                                    <span class="material-symbols-outlined me-2">auto_awesome</span>
                                    Feature Guides
                                </button>
                            </h2>
                            <div id="featuresCollapse" class="accordion-collapse collapse {% if doc_path.startswith('features') or doc_path == 'user-guides/economy_guide' %}show{% endif %}">
                                <div class="accordion-body p-0">
                                    <ul class="nav flex-column">
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'features/payroll/running-payroll' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='features/payroll/running-payroll') }}">
                                                <span class="material-symbols-outlined me-2" style="font-size: 1rem;">receipt_long</span>
                                                Payroll
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'features/store/creating-items' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='features/store/creating-items') }}">
                                                <span class="material-symbols-outlined me-2" style="font-size: 1rem;">store</span>
                                                Store & Items
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'features/banking/transferring-money' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='features/banking/transferring-money') }}">
                                                <span class="material-symbols-outlined me-2" style="font-size: 1rem;">account_balance</span>
                                                Banking & Transfers
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'user-guides/economy_guide' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='user-guides/economy_guide') }}">
                                                <span class="material-symbols-outlined me-2" style="font-size: 1rem;">emoji_objects</span>
                                                Economy Design
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Reference -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button {% if not doc_path.startswith('technical-reference') %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#technicalCollapse" aria-expanded="{% if doc_path.startswith('technical-reference') %}true{% else %}false{% endif %}">
                                    <span class="material-symbols-outlined me-2">code</span>
                                    Technical Reference
                                </button>
                            </h2>
                            <div id="technicalCollapse" class="accordion-collapse collapse {% if doc_path.startswith('technical-reference') %}show{% endif %}">
                                <div class="accordion-body p-0">
                                    <ul class="nav flex-column">
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'technical-reference/architecture' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='technical-reference/architecture') }}">
                                                Architecture
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'technical-reference/database_schema' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='technical-reference/database_schema') }}">
                                                Database Schema
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'technical-reference/ECONOMY_SPECIFICATION' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='technical-reference/ECONOMY_SPECIFICATION') }}">
                                                Economy Spec
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'technical-reference/api_reference' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='technical-reference/api_reference') }}">
                                                API Reference
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Reference & Project Info -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button {% if not (doc_path in ['CHANGELOG', 'Deployment_Guide', 'project/PROJECT_HISTORY'] or doc_path.startswith('development/') or doc_path.startswith('operations/')) %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#projectCollapse" aria-expanded="{% if doc_path in ['CHANGELOG', 'Deployment_Guide', 'project/PROJECT_HISTORY'] or doc_path.startswith('development/') or doc_path.startswith('operations/') %}true{% else %}false{% endif %}">
                                    <span class="material-symbols-outlined me-2">folder</span>
                                    Reference & Project
                                </button>
                            </h2>
                            <div id="projectCollapse" class="accordion-collapse collapse {% if doc_path in ['CHANGELOG', 'Deployment_Guide', 'project/PROJECT_HISTORY'] or doc_path.startswith('development/') or doc_path.startswith('operations/') %}show{% endif %}">
                                <div class="accordion-body p-0">
                                    <ul class="nav flex-column">
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'CHANGELOG' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='CHANGELOG') }}">
                                                Changelog
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'Deployment_Guide' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='Deployment_Guide') }}">
                                                Deployment
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'project/PROJECT_HISTORY' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='project/PROJECT_HISTORY') }}">
                                                Project History
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'development/DEVELOPMENT' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='development/DEVELOPMENT') }}">
                                                Development
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link {% if doc_path == 'operations/README' %}active{% endif %}" href="{{ url_for('docs.view_doc', doc_path='operations/README') }}">
                                                Operations
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            <div class="docs-backdrop" id="docsBackdrop" aria-hidden="true"></div>

            <!-- Main Content Area -->
            <main class="docs-main col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Mobile Sidebar Toggle -->
                <div class="d-md-none my-3">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#docsSidebar" aria-expanded="false" aria-controls="docsSidebar" aria-label="Toggle documentation sidebar">
                        <span class="material-symbols-outlined icon-align">menu</span>
                        Menu
                    </button>
                </div>

                <!-- Breadcrumbs -->
                {% if breadcrumbs %}
                <nav aria-label="breadcrumb" class="mt-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('docs.index') }}">Docs</a></li>
                        {% for crumb in breadcrumbs %}
                            {% if loop.last %}
                            <li class="breadcrumb-item active" aria-current="page">{{ crumb.title }}</li>
                            {% else %}
                            <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.title }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </nav>
                {% endif %}

                <!-- Mobile TOC (Collapsible) - Only visible on mobile/tablet -->
                {% if toc %}
                <div class="d-lg-none mb-4">
                    <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobileTOC" aria-expanded="false" aria-controls="mobileTOC" aria-label="Toggle table of contents">
                        <span class="material-symbols-outlined icon-align">list</span>
                        Navigation (Table of Contents)
                    </button>
                    <div class="collapse mt-2" id="mobileTOC">
                        <div class="toc-wrapper">
                            <h3 class="h5 toclabel">Navigation</h3>
                            {{ toc | safe }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Article Content -->
                <article class="docs-content py-4">
                    <div class="row">
                        <div class="{% if toc %}col-lg-9{% else %}col-12{% endif %} docs-article-column">
                            <div id="docs-content-top"></div>
                            <!-- Role Badges -->
                            {% if roles %}
                            <div class="mb-3">
                                {% for role in roles %}
                                <span class="badge {% if role == 'teacher' %}bg-danger{% elif role == 'student' %}bg-primary{% elif role == 'developer' %}bg-secondary{% endif %} me-1">
                                    {% if role == 'teacher' %}
                                        <span class="material-symbols-outlined icon-badge">person</span> Teacher
                                    {% elif role == 'student' %}
                                        <span class="material-symbols-outlined icon-badge">school</span> Student
                                    {% elif role == 'developer' %}
                                        <span class="material-symbols-outlined icon-badge">code</span> Developer
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Markdown Content -->
                            <div class="markdown-content{% if toc %} markdown-content-with-toc{% endif %}">
                                {{ content | safe }}
                            </div>

                            <!-- Related Articles -->
                            {% if related and related|length > 0 %}
                            <div class="related-articles mt-5 pt-4 border-top">
                                <h4 class="mb-3">
                                    <span class="material-symbols-outlined icon-align">bookmark</span>
                                    Related Articles
                                </h4>
                                <div class="row g-3">
                                    {% for article in related %}
                                    <div class="col-md-6">
                                        <div class="card h-100 border-primary border-opacity-25">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <a href="{{ article.url }}" class="text-decoration-none stretched-link">
                                                        {{ article.title }}
                                                    </a>
                                                </h6>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Table of Contents (if present) -->
                        {% if toc %}
                        <aside class="col-lg-3 docs-toc-column">
                            <div class="sticky-top toc-sticky">
                                <div class="toc-wrapper">
                                    <h3 class="h5  toclabel">Navigation</h3>
                                    {{ toc | safe }}
                                    
                                </div>
                                <div class="text-end mt-4">
                                        <a href="#docs-content-top" class="btn btn-primary">
                                        <span class="material-symbols-outlined icon-align">arrow_upward</span>
                                        Back to Top
                                        </a>
                                    </div>
                            </div>
                        </aside>
                        {% endif %}
                    </div>

                    <!-- Scroll to Top -->
                    
                </article>
            </main>
        </div>
    </div>
</div>

<style>
/* Documentation-specific styles */

/* Icon alignment utilities */
.icon-align {
    vertical-align: middle;
    font-size: 1.2rem;
}

.icon-small {
    vertical-align: middle;
    font-size: 1rem;
}

.icon-badge {
    vertical-align: middle;
    font-size: 0.9rem;
}

.docs-layout .docs-sidebar {
    height: 100%;
    max-height: none;
    overflow-y: auto;
    border-right: 1px solid #e5e5e3;
}

.docs-layout .docs-sidebar .nav-link {
    color: #212529;
    padding: 0.25rem 1rem;
    font-size: 0.9rem;
}

.docs-layout .docs-sidebar .nav-link:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.docs-layout .docs-sidebar .nav-link.active {
    background-color: var(--primary);
    color: var(--secondary);
}

.sidebar-heading {
    font-size: 0.8rem;
    text-transform: uppercase;
    font-weight:600;
    color:var(--primary);
}

/* Markdown Content Styling */
.markdown-content {
    font-size: 1rem;
    line-height: 1.7;
    max-width: 900px;
}

/* Override max-width when TOC is present */
.markdown-content-with-toc {
    max-width: none;
}

.markdown-content h1 {
    font-size: 2.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.markdown-content h2 {
    font-size: 2rem;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.markdown-content h3 {
    font-size: 1.5rem;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}

.markdown-content h4 {
    font-size: 1.25rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

.markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    color: #e83e8c;
}

.markdown-content pre {
    background-color: #2d2d2d;
    color: #f8f8f2;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.markdown-content pre code {
    background: transparent;
    color: inherit;
    padding: 0;
}

.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin: 1rem 0;
}

.markdown-content table {
    width: 100%;
    margin: 1rem 0;
    border-collapse: collapse;
}

.markdown-content table th,
.markdown-content table td {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
}

.markdown-content table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.markdown-content blockquote {
    border-left: 4px solid var(--primary);
    padding-left: 1rem;
    margin: 1rem 0;
    color: #6c757d;
}

.markdown-content ul,
.markdown-content ol {
    padding-left: 2rem;
    margin: 1rem 0;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

/* Table of Contents */
.toc-sticky {
    top: 2rem;
}

.toc-wrapper {
    border: 2px solid var(--primary);
    padding: 1rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
}

.toc-wrapper .toclabel{
    font-weight: 600;
   
    color: var(--primary);
}


.toc-wrapper a {
    color: #212529;
    text-decoration: none;
}

.toc-wrapper a:hover {
    background-color: rgba(26, 77, 71, 0.2);
    font-weight:600;
}

.btn {
    border-radius: var(--radius-sm);
    border-width:2px;
    font-weight: 500;
    padding: 0.625rem 1.25rem;
    transition: all 0.2s ease;
}

.btn-primary {
    background-color: var(--primary);
    border-color: var(--primary);
    color: white;
}

.btn-primary:hover {
    background-color: #d3af37;
    color: var(--primary);
}

.docs-layout {
    height: 100vh;
    overflow: hidden;
}

/* Use dynamic viewport height where supported to avoid mobile 100vh issues */
@supports (height: 100dvh) {
    .docs-layout {
        height: 100dvh;
    }
}
.docs-layout > .container-fluid,
.docs-layout > .container-fluid > .row {
    height: 100%;
}

.docs-main {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

.docs-content {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-height: 0;
}

.docs-content > .row {
    flex: 1 1 auto;
    min-height: 0;
}

.docs-article-column {
    height: 100%;
    overflow-y: auto;
}

.docs-toc-column {
    height: 100%;
    overflow-y: auto;
}

/* Docs offcanvas on mobile */
@media (max-width: 991.98px) {
    .docs-layout .docs-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        max-width: 90%;
        height: 100vh;
        padding: 1.25rem;
        transform: translateX(-100%);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: none;
        z-index: 1040;
    }

    .docs-layout .docs-sidebar.show {
        transform: translateX(0);
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.25);
    }

    .docs-layout .docs-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 1030;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .docs-layout .docs-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
}

/* Keep sidebar visible on desktop */
@media (min-width: 992px) {
    .docs-layout .docs-sidebar {
        position: static;
        height: auto;
        transform: none !important;
        box-shadow: none;
    }

    .docs-layout .docs-sidebar.collapse {
        display: block !important;
        visibility: visible;
    }

    .docs-layout .docs-sidebar.collapsing {
        height: auto !important;
        transition: none;
    }

    .docs-layout .docs-backdrop {
        display: none !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('docsSidebar');
    const backdrop = document.getElementById('docsBackdrop');

    if (!sidebar || !backdrop) return;

    const collapse = bootstrap.Collapse.getOrCreateInstance(sidebar, {
        toggle: false
    });

    sidebar.addEventListener('shown.bs.collapse', () => {
        backdrop.classList.add('show');
    });

    sidebar.addEventListener('hidden.bs.collapse', () => {
        backdrop.classList.remove('show');
    });

    backdrop.addEventListener('click', () => {
        collapse.hide();
    });
});
</script>
{% endblock %}
