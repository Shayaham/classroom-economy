# Version 2.0: Flexible Attendance & Payroll - Implementation Roadmap

**Feature:** Flexible Attendance & Payroll System
**Version:** 2.0.0
**Status:** Planning Phase
**Created:** 2026-01-03
**Last Updated:** 2026-01-03

---

## Overview

This roadmap provides a detailed, phase-by-phase implementation plan for Version 2.0. Each phase is designed to be independently implementable and testable, resulting in a separate pull request.

**Related Documents:**
- **Specification:** `docs/specifications/v2.0-flexible-attendance-payroll.md`
- **Agent Instructions:** `.claude/rules/attendance-payroll-v2.md`
- **Design Decisions:** `docs/design-decisions/v2.0-attendance-payroll-decisions.md`

---

## Prerequisites

Before starting implementation:

- [ ] Read full specification document
- [ ] Read agent instructions
- [ ] Read design decisions document
- [ ] Review user wireframes
- [ ] Create feature branch: `feature/v2.0-attendance-payroll`
- [ ] Set up development environment
- [ ] Ensure all existing tests pass

---

## Phase 1: Database Schema & Migrations

**Estimated Effort:** 1-2 days
**PR Number:** TBD
**Status:** Not Started

### Objectives

- Create `AttendanceLog` table with proper indexes
- Add new fields to `PayrollSettings` model
- Add new field to `TeacherBlock` model
- Ensure backward compatibility with defaults

### Tasks

#### 1.1 Create AttendanceLog Model

**File:** `app/models.py`

- [ ] Add `AttendanceLog` class definition
- [ ] Add fields: `id`, `student_id`, `join_code`, `timestamp`, `status`, `period`
- [ ] Add fields: `created_by`, `modified_by`, `modified_at`
- [ ] Add fields: `entry_type`, `is_system_generated`, `notes`
- [ ] Add relationship to `Student` model
- [ ] Add indexes: `ix_attendance_join_code_timestamp`, `ix_attendance_student_join_code`
- [ ] Add `__repr__` method for debugging

**Code Checklist:**
- [ ] All fields have appropriate types (String, DateTime, Boolean, etc.)
- [ ] Nullable constraints are correct
- [ ] Defaults are set for optional fields
- [ ] Foreign keys are defined
- [ ] Indexes are defined in `__table_args__`

#### 1.2 Modify PayrollSettings Model

**File:** `app/models.py`

- [ ] Add `payroll_type` field (String, default='time_based')
- [ ] Add `attendance_flat_rate` field (Numeric(10, 2), default=0.00)
- [ ] Add `student_tracking_enabled` field (Boolean, default=True)
- [ ] Add `teacher_tracking_enabled` field (Boolean, default=False)
- [ ] Add `conflict_resolution` field (String, default='last_entry')

**Code Checklist:**
- [ ] All defaults preserve backward compatibility
- [ ] Numeric fields have appropriate precision
- [ ] String fields have appropriate length

#### 1.3 Modify TeacherBlock Model

**File:** `app/models.py`

- [ ] Add `attendance_enabled` field (Boolean, default=True)

**Code Checklist:**
- [ ] Default value preserves backward compatibility

#### 1.4 Generate Migration

**Command:** `flask db migrate -m "Add AttendanceLog and update PayrollSettings for v2.0"`

- [ ] Run migration command
- [ ] Review generated migration file in `migrations/versions/`
- [ ] Verify all columns are created with correct types
- [ ] Verify all indexes are created
- [ ] Verify all defaults are set
- [ ] Verify foreign keys are created

#### 1.5 Test Migration

- [ ] Test upgrade: `flask db upgrade`
- [ ] Verify tables exist: Check database schema
- [ ] Verify columns exist with correct types
- [ ] Verify indexes exist
- [ ] Test downgrade: `flask db downgrade`
- [ ] Verify tables/columns removed
- [ ] Re-upgrade: `flask db upgrade`
- [ ] Run existing tests: `pytest tests/`
- [ ] Verify no existing tests break

#### 1.6 Update Documentation

- [ ] Update `docs/technical-reference/database_schema.md`
- [ ] Document `AttendanceLog` table structure
- [ ] Document new `PayrollSettings` fields
- [ ] Document new `TeacherBlock` field
- [ ] Update CHANGELOG.md

### Testing Requirements

**Unit Tests:** None required (models only)

**Integration Tests:**
- [ ] `test_attendance_log_creation()` - Can create AttendanceLog entry
- [ ] `test_payroll_settings_defaults()` - New fields have correct defaults
- [ ] `test_teacher_block_defaults()` - attendance_enabled defaults to True
- [ ] `test_migration_backward_compatibility()` - Existing data works after migration

**Migration Tests:**
- [ ] Test migration on empty database
- [ ] Test migration on database with existing data
- [ ] Test downgrade leaves no orphaned data

### Deliverables

- [ ] Updated `app/models.py` with new/modified models
- [ ] Migration file in `migrations/versions/`
- [ ] Updated database schema documentation
- [ ] Updated CHANGELOG.md
- [ ] All tests passing

### Exit Criteria

- [ ] Migration runs successfully (upgrade and downgrade)
- [ ] All existing tests still pass
- [ ] New model tests pass
- [ ] Documentation updated
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 2: Settings UI

**Estimated Effort:** 2-3 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 1

### Objectives

- Add attendance/payroll configuration section to Payroll Settings page
- Allow teachers to configure `payroll_type`, tracking controls, and conflict resolution
- Validate settings with clear error messages

### Tasks

#### 2.1 Create/Update Forms

**File:** `app/forms.py` (or create `app/forms_attendance.py`)

- [ ] Create `AttendancePayrollSettingsForm` or extend existing `PayrollSettingsForm`
- [ ] Add `payroll_type` field (RadioField: time_based, attendance_based)
- [ ] Add `attendance_flat_rate` field (DecimalField)
- [ ] Add `student_tracking_enabled` field (BooleanField)
- [ ] Add `teacher_tracking_enabled` field (BooleanField)
- [ ] Add `conflict_resolution` field (RadioField: last_entry, teacher_priority)
- [ ] Add validators:
  - `attendance_flat_rate` required if `payroll_type = 'attendance_based'`
  - At least one tracking method must be enabled

**Code Checklist:**
- [ ] Form extends FlaskForm
- [ ] CSRF token included
- [ ] Validators are comprehensive
- [ ] Help text/descriptions are clear

#### 2.2 Update Payroll Settings Route

**File:** `app/routes/admin.py` (or appropriate file)

- [ ] Update existing payroll settings route to handle new form fields
- [ ] Load current settings from `PayrollSettings`
- [ ] Validate form submission
- [ ] Save settings to database
- [ ] Show success/error flash messages
- [ ] Redirect back to settings page

**Code Checklist:**
- [ ] Route requires authentication
- [ ] Route scoped by `join_code` (multi-tenancy!)
- [ ] Form validation errors shown to user
- [ ] Success message shown on save

#### 2.3 Update Payroll Settings Template

**File:** `templates/settings/payroll_settings.html` (or appropriate template)

- [ ] Add new section: "Attendance & Payroll Configuration"
- [ ] Add payroll type radio buttons with descriptions
- [ ] Add attendance flat rate input (conditionally shown if attendance-based selected)
- [ ] Add tracking control checkboxes
- [ ] Add conflict resolution radio buttons (conditionally shown if both tracking enabled)
- [ ] Add help text explaining each option
- [ ] Add save button
- [ ] Style consistently with existing settings page

**UI Checklist:**
- [ ] Conditional visibility works (JS or server-side)
- [ ] Help text is clear and concise
- [ ] Form is accessible (labels, ARIA attributes)
- [ ] Mobile-responsive layout

#### 2.4 Add JavaScript for Conditional Visibility

**File:** Template or separate JS file

- [ ] Show/hide `attendance_flat_rate` based on `payroll_type` selection
- [ ] Show/hide `conflict_resolution` based on both tracking checkboxes
- [ ] Validate at least one tracking method is enabled (client-side)

**Code Checklist:**
- [ ] Vanilla JS or existing framework (no new dependencies)
- [ ] Gracefully degrades if JS disabled (server-side validation still works)

### Testing Requirements

**Unit Tests:**
- [ ] `test_form_validation_attendance_rate_required()` - Rate required for attendance-based
- [ ] `test_form_validation_at_least_one_tracking()` - At least one tracking method required

**Integration Tests:**
- [ ] `test_payroll_settings_page_loads()` - Page loads successfully
- [ ] `test_save_time_based_settings()` - Can save time-based settings
- [ ] `test_save_attendance_based_settings()` - Can save attendance-based settings
- [ ] `test_save_student_tracking_only()` - Can save student-tracking-only
- [ ] `test_save_teacher_tracking_only()` - Can save teacher-tracking-only
- [ ] `test_save_hybrid_tracking()` - Can save hybrid with conflict resolution
- [ ] `test_settings_scoped_by_join_code()` - Settings only affect current join_code

**UI Tests:**
- [ ] Test conditional visibility of fields
- [ ] Test form validation feedback
- [ ] Test mobile responsiveness

### Deliverables

- [ ] Updated/new form class
- [ ] Updated route handler
- [ ] Updated template with new fields
- [ ] JavaScript for conditional visibility
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] Settings can be saved successfully
- [ ] Validation works correctly
- [ ] Conditional visibility works
- [ ] All tests pass
- [ ] Multi-tenancy scoping verified
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 3: Attendance Utilities

**Estimated Effort:** 2-3 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 1, Phase 2

### Objectives

- Create helper functions for attendance entry creation, retrieval, and validation
- Implement conflict resolution logic
- Implement backdating and payroll impact checking

### Tasks

#### 3.1 Create Attendance Utilities Module

**File:** `app/utils/attendance_utils.py`

Functions to implement:

- [ ] `create_attendance_entry(student_id, join_code, status, created_by, period=None, timestamp=None, notes=None)`
  - Check for existing entry
  - Apply conflict resolution
  - Create or update entry
  - Return created/updated entry

- [ ] `get_student_attendance(student_id, join_code, date=None, period=None)`
  - Get attendance for a student on a specific date
  - Scope by join_code
  - Return entry or None

- [ ] `get_class_attendance(join_code, period, date=None)`
  - Get all attendance for a class period on a date
  - Scope by join_code
  - Return list of entries

- [ ] `can_edit_entry(entry)`
  - Check if entry can be edited
  - Return False if `is_system_generated=True`
  - Return True otherwise

- [ ] `check_payroll_impact(entry)`
  - Check if entry's timestamp is in unpaid payroll period
  - Query Transaction table for payroll transactions
  - Return True if affects unpaid payroll, False otherwise

- [ ] `get_valid_statuses(payroll_type)`
  - Return list of valid status values for given payroll type
  - time_based: ['inactive', 'start_work', 'done']
  - attendance_based: ['present', 'absent', 'late']

- [ ] `calculate_attendance_payroll(student_id, join_code, pay_period_start, pay_period_end)`
  - Count 'present' entries in date range
  - Get `attendance_flat_rate` from settings
  - Calculate total: count Ã— rate
  - Return payroll dict

**Code Checklist:**
- [ ] All functions properly documented (docstrings)
- [ ] All queries scoped by `join_code`
- [ ] Error handling for edge cases
- [ ] Type hints for parameters and return values

### Testing Requirements

**Unit Tests:**
- [ ] `test_create_attendance_entry_new()` - Create new entry successfully
- [ ] `test_create_attendance_entry_duplicate_last_entry()` - Last entry wins
- [ ] `test_create_attendance_entry_duplicate_teacher_priority()` - Teacher priority respected
- [ ] `test_create_attendance_entry_conflict_student_rejected()` - Student can't override teacher
- [ ] `test_get_student_attendance()` - Retrieve student attendance correctly
- [ ] `test_get_class_attendance()` - Retrieve class attendance correctly
- [ ] `test_can_edit_entry_manual()` - Manual entry can be edited
- [ ] `test_can_edit_entry_system()` - System entry cannot be edited
- [ ] `test_check_payroll_impact_unpaid()` - Detects unpaid period
- [ ] `test_check_payroll_impact_paid()` - Detects paid period
- [ ] `test_get_valid_statuses_time_based()` - Returns correct statuses
- [ ] `test_get_valid_statuses_attendance_based()` - Returns correct statuses
- [ ] `test_calculate_attendance_payroll()` - Calculates payroll correctly

**Multi-Tenancy Tests:**
- [ ] `test_create_entry_scoped_by_join_code()` - Can't affect other join codes
- [ ] `test_get_attendance_scoped_by_join_code()` - Only returns own join code data

### Deliverables

- [ ] `app/utils/attendance_utils.py` with all functions
- [ ] Comprehensive unit tests
- [ ] Documentation of utility functions
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] All utility functions implemented
- [ ] All tests passing
- [ ] Multi-tenancy verified
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 4: Daily Attendance Interface

**Estimated Effort:** 4-5 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 3

### Objectives

- Create Attendance Management page with Daily Attendance tab
- Allow teachers to mark student attendance for current day
- Support bulk operations and individual status changes
- Show statistics and auto-save

### Tasks

#### 4.1 Create Attendance Blueprint

**File:** `app/routes/attendance.py`

- [ ] Create new blueprint: `attendance_bp`
- [ ] Register blueprint in `app/__init__.py`

#### 4.2 Create Management Page Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/management`
- [ ] Require authentication (teacher role)
- [ ] Check if `teacher_tracking_enabled = True` (else redirect with message)
- [ ] Render management template

#### 4.3 Create Daily Attendance Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/daily` (GET and POST)
- [ ] GET: Load students for selected period, load existing attendance for today
- [ ] POST: Process attendance updates for students
- [ ] Use `create_attendance_entry()` from utilities
- [ ] Return JSON response for AJAX (or redirect for traditional form)
- [ ] Scope by `join_code`

#### 4.4 Create Attendance Control Update Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/period-control` (POST)
- [ ] Update `attendance_enabled` for specific `TeacherBlock`
- [ ] Return JSON response
- [ ] Scope by `join_code`

#### 4.5 Create Templates

**File:** `templates/attendance/management.html`

- [ ] Create base layout with two tabs: Daily Attendance, Attendance Log
- [ ] Include tab switching logic (JS or server-side)
- [ ] Include period selector tabs (Period 1, Period 2, etc.)
- [ ] Load periods from current teacher's `TeacherBlock` records

**File:** `templates/attendance/daily_tab.html`

- [ ] Create Attendance Control section with per-period toggles
- [ ] Create student roster table with checkboxes
- [ ] Create status dropdown for each student
- [ ] Create "Apply to Selected" bulk action dropdown
- [ ] Create statistics panel (Present, Absent, Late counts)
- [ ] Create auto-save functionality (AJAX)
- [ ] Show unsaved changes warning if navigating away

**Code Checklist:**
- [ ] CSRF tokens included in forms
- [ ] JavaScript for auto-save and bulk operations
- [ ] Accessible UI (labels, ARIA)
- [ ] Mobile-responsive

#### 4.6 Add Navigation Menu Item

**File:** `templates/admin_dashboard.html` (or appropriate template)

- [ ] Add "Attendance" menu item
- [ ] Only show if `teacher_tracking_enabled = True`
- [ ] Link to `/attendance/management`

### Testing Requirements

**Integration Tests:**
- [ ] `test_attendance_management_page_loads()` - Page accessible
- [ ] `test_daily_tab_visibility_enabled()` - Tab shown if enabled
- [ ] `test_daily_tab_visibility_disabled()` - Tab hidden if disabled
- [ ] `test_mark_single_student_present()` - Can mark one student present
- [ ] `test_mark_all_students_present()` - Can bulk mark all present
- [ ] `test_apply_to_selected()` - Bulk apply works correctly
- [ ] `test_period_switching()` - Period tabs work correctly
- [ ] `test_attendance_control_toggle()` - Per-period toggle works
- [ ] `test_auto_save()` - Auto-save functionality works
- [ ] `test_statistics_update()` - Statistics panel updates correctly

**Multi-Tenancy Tests:**
- [ ] `test_daily_attendance_scoped_by_join_code()` - Only shows students for current join code
- [ ] `test_cannot_mark_other_join_code_students()` - Cannot affect other teachers' students

**UI Tests:**
- [ ] Test bulk selection
- [ ] Test dropdown functionality
- [ ] Test statistics calculation

### Deliverables

- [ ] New attendance blueprint
- [ ] Management page route and template
- [ ] Daily attendance tab route and template
- [ ] Navigation menu update
- [ ] JavaScript for UI interactions
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] Daily Attendance tab functional
- [ ] Bulk operations work
- [ ] Statistics accurate
- [ ] Auto-save works
- [ ] All tests pass
- [ ] Multi-tenancy verified
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 5: Attendance Log Interface

**Estimated Effort:** 4-5 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 4

### Objectives

- Create Attendance Log tab for viewing historical attendance
- Support filtering, searching, and pagination
- Allow editing/deleting entries (with restrictions)
- Implement bulk add functionality

### Tasks

#### 5.1 Create Attendance Log Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/log` (GET)
- [ ] Support query params: date_from, date_to, period, status, created_by, page
- [ ] Query `AttendanceLog` with filters
- [ ] Paginate results (20 per page)
- [ ] Scope by `join_code`
- [ ] Render log template

#### 5.2 Create Edit Entry Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/edit/<int:entry_id>` (GET and POST)
- [ ] GET: Show edit modal/form
- [ ] POST: Process edit
- [ ] Check `can_edit_entry()` - block if system-generated
- [ ] Check `check_payroll_impact()` - warn if affects unpaid payroll
- [ ] Update entry using `create_attendance_entry()` (will update existing)
- [ ] Scope by `join_code`

#### 5.3 Create Delete Entry Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/delete/<int:entry_id>` (POST)
- [ ] Check `can_edit_entry()` - block if system-generated
- [ ] Check `check_payroll_impact()` - warn if affects unpaid payroll
- [ ] Delete entry
- [ ] Scope by `join_code`

#### 5.4 Create Bulk Add Route

**File:** `app/routes/attendance.py`

- [ ] Add route: `/attendance/bulk-add` (POST)
- [ ] Accept: period, timestamp, status
- [ ] Get all students for join_code + period
- [ ] Create attendance entry for each student
- [ ] Return success/failure counts

#### 5.5 Create Log Tab Template

**File:** `templates/attendance/log_tab.html`

- [ ] Create filter panel with date, period, status, created_by dropdowns
- [ ] Create log table with columns: Name, Timestamp, Status, Created By, Actions
- [ ] Add pagination controls
- [ ] Add "Bulk Add" button
- [ ] Create details panel (shown when entry selected)
- [ ] Show Edit/Delete buttons (disabled for system-generated)

**File:** `templates/attendance/edit_modal.html`

- [ ] Create modal with timestamp and status fields
- [ ] Include warning if affects unpaid payroll
- [ ] Include confirmation dialog

**File:** `templates/attendance/bulk_add_modal.html`

- [ ] Create modal with period, timestamp, status fields
- [ ] Include confirmation message

**Code Checklist:**
- [ ] CSRF tokens in forms
- [ ] JavaScript for modals
- [ ] Accessible UI
- [ ] Mobile-responsive

### Testing Requirements

**Integration Tests:**
- [ ] `test_attendance_log_page_loads()` - Page loads
- [ ] `test_log_filtering()` - Filters work correctly
- [ ] `test_log_pagination()` - Pagination works
- [ ] `test_edit_entry_manual()` - Can edit manual entry
- [ ] `test_edit_entry_system_blocked()` - Cannot edit system entry
- [ ] `test_edit_entry_payroll_warning()` - Warning shown if affects payroll
- [ ] `test_delete_entry_manual()` - Can delete manual entry
- [ ] `test_delete_entry_system_blocked()` - Cannot delete system entry
- [ ] `test_bulk_add()` - Bulk add creates entries for all students
- [ ] `test_details_panel()` - Details panel shows correct data

**Multi-Tenancy Tests:**
- [ ] `test_log_scoped_by_join_code()` - Only shows entries for current join code
- [ ] `test_cannot_edit_other_join_code_entry()` - Cannot edit entries from other teachers
- [ ] `test_bulk_add_scoped()` - Bulk add only affects current join code

### Deliverables

- [ ] Attendance Log routes
- [ ] Log tab template
- [ ] Edit modal template
- [ ] Delete functionality
- [ ] Bulk add modal and functionality
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] Attendance Log tab functional
- [ ] Filtering works
- [ ] Edit/Delete work with proper restrictions
- [ ] Bulk add works
- [ ] All tests pass
- [ ] Multi-tenancy verified
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 6: Payroll Calculation Update

**Estimated Effort:** 3-4 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 3, Phase 5

### Objectives

- Update payroll calculation to support both time-based and attendance-based
- Update payroll reports to show relevant data per type
- Test mixed payroll scenarios (switching mid-year)

### Tasks

#### 6.1 Update Payroll Calculation Logic

**File:** `app/payroll.py`

- [ ] Locate existing `calculate_payroll()` function (or equivalent)
- [ ] Add check for `payroll_type` from `PayrollSettings`
- [ ] If `time_based`: Use existing calculation (TapEvent data)
- [ ] If `attendance_based`: Call `calculate_attendance_payroll()` from utilities
- [ ] Return consistent structure regardless of type

**Code Checklist:**
- [ ] Backward compatibility maintained
- [ ] Both calculation methods return same structure
- [ ] Scope by `join_code`

#### 6.2 Update Payroll Report Generation

**File:** `app/payroll.py` (or relevant file)

- [ ] Update payroll report logic to check `payroll_type`
- [ ] If `time_based`: Show columns: Hours Worked, Hourly Rate, Total
- [ ] If `attendance_based`: Show columns: Days Present, Rate Per Day, Total
- [ ] Include payroll type indicator in report

#### 6.3 Update Payroll Report Template

**File:** `templates/payroll/report.html` (or relevant template)

- [ ] Conditionally show different columns based on payroll type
- [ ] Add indicator showing which calculation method was used
- [ ] Ensure clarity for mixed scenarios (if teacher switched mid-year)

**Code Checklist:**
- [ ] Template handles both payroll types
- [ ] Clear labeling of calculation method
- [ ] Historical reports show correct type

#### 6.4 Handle Mixed Payroll Scenarios

- [ ] Document behavior when teacher switches payroll type mid-year
- [ ] Ensure historical data preserved correctly
- [ ] Test reports that span both time-based and attendance-based periods

### Testing Requirements

**Unit Tests:**
- [ ] `test_calculate_payroll_time_based()` - Time-based calculation works
- [ ] `test_calculate_payroll_attendance_based()` - Attendance-based calculation works
- [ ] `test_calculate_payroll_mixed()` - Mixed scenario handled correctly

**Integration Tests:**
- [ ] `test_payroll_report_time_based()` - Report shows correct columns for time-based
- [ ] `test_payroll_report_attendance_based()` - Report shows correct columns for attendance-based
- [ ] `test_payroll_switch_mid_year()` - Can generate report spanning both types

**Regression Tests:**
- [ ] `test_existing_time_based_unchanged()` - Existing time-based classes work unchanged

### Deliverables

- [ ] Updated payroll calculation logic
- [ ] Updated payroll report generation
- [ ] Updated payroll report template
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] Payroll calculation works for both types
- [ ] Reports accurate for both types
- [ ] Mixed scenarios handled correctly
- [ ] All tests pass
- [ ] No regression in existing functionality
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 7: Hall Pass Integration

**Estimated Effort:** 3-4 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 6

### Objectives

- Update hall pass creation to check payroll type
- Implement attendance-based behavior (no time pause)
- Create AttendanceLog entries for hall pass events
- Implement teacher-initiated hall passes

### Tasks

#### 7.1 Update Hall Pass Creation Logic

**File:** `app/routes/student.py` (or wherever hall pass creation is)

- [ ] Locate existing hall pass creation function
- [ ] Add check for `payroll_type` from `PayrollSettings`
- [ ] If `time_based`: Pause time tracking (existing behavior)
- [ ] If `attendance_based`: Do NOT pause time (new behavior)
- [ ] Create `AttendanceLog` entry with:
  - `entry_type = 'hall_pass'`
  - `is_system_generated = True`
  - `status = 'hall_pass'` (or appropriate status)
  - `created_by = 'system'`

**Code Checklist:**
- [ ] Backward compatibility maintained (time-based unchanged)
- [ ] AttendanceLog entry created in both cases
- [ ] Scope by `join_code`

#### 7.2 Update Hall Pass Return Logic

**File:** Same as above

- [ ] If `time_based`: Resume time tracking (existing behavior)
- [ ] If `attendance_based`: No time change (new behavior)
- [ ] No additional AttendanceLog entry needed (hall pass entry already exists)

#### 7.3 Implement Teacher-Initiated Hall Pass

**File:** `app/routes/admin.py` (or create new route in attendance blueprint)

- [ ] Add route: `/hall-pass/teacher-initiate` (GET and POST)
- [ ] GET: Show form to select student and destination
- [ ] POST: Create hall pass on behalf of student
  - Set `created_by = 'teacher'` in hall pass record
  - Use same logic as student-initiated (check payroll type, etc.)
  - Create AttendanceLog entry with `created_by = 'teacher'`

**Template:**
- [ ] Create teacher hall pass initiation form
- [ ] Student selector dropdown (scope by join_code!)
- [ ] Destination selector
- [ ] Submit button

**Code Checklist:**
- [ ] Only accessible if `student_tracking_enabled = False` (or always available but less emphasized)
- [ ] Scope by `join_code`

#### 7.4 Update Hall Pass UI

**File:** `templates/hall_pass/...` (relevant templates)

- [ ] Show indicator if hall pass was teacher-initiated
- [ ] Student can still return hall pass themselves (or teacher can return)

### Testing Requirements

**Unit Tests:**
- [ ] `test_hall_pass_time_based_pauses_time()` - Time paused in time-based mode
- [ ] `test_hall_pass_attendance_based_no_pause()` - Time NOT paused in attendance-based mode
- [ ] `test_hall_pass_creates_attendance_log()` - AttendanceLog entry created

**Integration Tests:**
- [ ] `test_hall_pass_student_initiated()` - Student-initiated hall pass works
- [ ] `test_hall_pass_teacher_initiated()` - Teacher-initiated hall pass works
- [ ] `test_hall_pass_return()` - Returning hall pass works correctly
- [ ] `test_hall_pass_attendance_log_read_only()` - Hall pass entries cannot be edited

**Regression Tests:**
- [ ] `test_existing_hall_pass_unchanged()` - Existing hall pass functionality works

### Deliverables

- [ ] Updated hall pass creation logic
- [ ] Teacher-initiated hall pass feature
- [ ] AttendanceLog integration
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] Hall pass behavior correct for both payroll types
- [ ] Teacher-initiated hall passes work
- [ ] AttendanceLog entries created
- [ ] All tests pass
- [ ] No regression in existing functionality
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 8: Student UI Updates

**Estimated Effort:** 3-4 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 7

### Objectives

- Update student clock-in/out pages based on settings
- Hide clock-in if student tracking disabled
- Implement attendance-based check-in UI
- Show status (marked by teacher vs. self-reported)

### Tasks

#### 8.1 Update Clock-In Page Route

**File:** `app/routes/student.py`

- [ ] Update clock-in route to check:
  - `student_tracking_enabled` from `PayrollSettings`
  - `attendance_enabled` from current period's `TeacherBlock`
  - `payroll_type` from `PayrollSettings`
- [ ] If tracking disabled: Show "Teacher is managing attendance" message
- [ ] If attendance-based: Show check-in UI (not clock-in)
- [ ] If time-based: Show existing clock-in UI

**Code Checklist:**
- [ ] Scope by `join_code`
- [ ] Conditional logic handles all scenarios

#### 8.2 Create Attendance Check-In Template

**File:** `templates/productivity/attendance_check_in.html` (or update existing)

- [ ] If `student_tracking_enabled = False`:
  - Show message: "Your teacher is managing attendance for this class period."
  - Show current status if teacher has marked (Present/Absent/Late)
  - Show timestamp of marking
  - No action buttons

- [ ] If `student_tracking_enabled = True` and `payroll_type = 'attendance_based'`:
  - Show "Check In" button (not "Clock In")
  - After check-in: Show "You're marked present for today's class!"
  - No "Check Out" button
  - Show timestamp of check-in

- [ ] If `student_tracking_enabled = True` and `payroll_type = 'time_based'`:
  - Show existing clock-in/out UI (no changes)

**Code Checklist:**
- [ ] Clear messaging for each scenario
- [ ] Accessible UI
- [ ] Mobile-responsive

#### 8.3 Update Student Dashboard

**File:** `templates/student_dashboard.html` (or relevant template)

- [ ] Show attendance status on dashboard
- [ ] If teacher-marked: Show "Attendance: Present (marked by teacher)"
- [ ] If self-reported: Show "Attendance: Present (checked in at 10:45 AM)"
- [ ] If not marked: Show "Attendance: Not checked in"

#### 8.4 Create Check-In Route

**File:** `app/routes/student.py`

- [ ] Add route: `/attendance/check-in` (POST)
- [ ] Check if student can mark attendance (tracking enabled, period enabled)
- [ ] Check for duplicate (already checked in today)
- [ ] Create attendance entry using `create_attendance_entry()`
- [ ] Return success/error message
- [ ] Scope by `join_code`

**Code Checklist:**
- [ ] Prevents duplicate check-ins
- [ ] Scope by `join_code`
- [ ] Error handling for edge cases

### Testing Requirements

**Integration Tests:**
- [ ] `test_clock_in_disabled_shows_message()` - Message shown if tracking disabled
- [ ] `test_attendance_check_in()` - Student can check in (attendance-based)
- [ ] `test_attendance_check_in_duplicate_blocked()` - Cannot check in twice
- [ ] `test_time_clock_in_unchanged()` - Existing clock-in still works (time-based)
- [ ] `test_dashboard_shows_status()` - Dashboard shows correct attendance status

**Multi-Tenancy Tests:**
- [ ] `test_check_in_scoped_by_join_code()` - Cannot affect other teachers' attendance

**UI Tests:**
- [ ] Test check-in button functionality
- [ ] Test messaging clarity
- [ ] Test mobile responsiveness

### Deliverables

- [ ] Updated clock-in page route
- [ ] Attendance check-in template
- [ ] Updated student dashboard
- [ ] Check-in route
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] Student UI adapts correctly to settings
- [ ] Check-in functionality works
- [ ] Clear messaging for all scenarios
- [ ] All tests pass
- [ ] Multi-tenancy verified
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 9: Reporting & Analytics

**Estimated Effort:** 4-5 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** Phase 8

### Objectives

- Create daily attendance summary report
- Create student attendance history report
- Create period comparison report
- Create attendance vs. payroll correlation report
- Export functionality

### Tasks

#### 9.1 Create Report Routes

**File:** `app/routes/attendance.py` (or `app/routes/reports.py`)

- [ ] Add route: `/reports/daily-attendance-summary`
  - Show present/absent/late counts per day
  - Filter by date range, period
  - Scope by `join_code`

- [ ] Add route: `/reports/student-attendance-history`
  - Show attendance history for selected student
  - Filter by date range
  - Scope by `join_code`

- [ ] Add route: `/reports/period-comparison`
  - Compare attendance rates across periods
  - Show averages, trends
  - Scope by `join_code`

- [ ] Add route: `/reports/attendance-payroll-correlation`
  - Show relationship between attendance and earnings
  - Only relevant for attendance-based payroll
  - Scope by `join_code`

#### 9.2 Create Report Templates

**Files:** `templates/reports/...`

- [ ] `daily_attendance_summary.html`
  - Table or chart showing daily statistics
  - Date range selector
  - Period filter
  - Export button

- [ ] `student_attendance_history.html`
  - Student selector
  - Date range selector
  - Table showing daily attendance
  - Export button

- [ ] `period_comparison.html`
  - Chart comparing periods
  - Statistics table
  - Export button

- [ ] `attendance_payroll_correlation.html`
  - Chart showing correlation
  - Statistics
  - Export button

**Code Checklist:**
- [ ] Charts/visualizations (Chart.js or similar)
- [ ] Accessible data tables
- [ ] Mobile-responsive
- [ ] Export functionality (CSV)

#### 9.3 Implement Export Functionality

**File:** `app/routes/attendance.py` (or appropriate file)

- [ ] Add CSV export for each report type
- [ ] Generate CSV from query results
- [ ] Set appropriate headers (Content-Type, Content-Disposition)
- [ ] Scope by `join_code`

### Testing Requirements

**Integration Tests:**
- [ ] `test_daily_summary_report()` - Report generates correctly
- [ ] `test_student_history_report()` - Report generates correctly
- [ ] `test_period_comparison_report()` - Report generates correctly
- [ ] `test_attendance_payroll_report()` - Report generates correctly
- [ ] `test_export_csv()` - CSV export works for each report type

**Multi-Tenancy Tests:**
- [ ] `test_reports_scoped_by_join_code()` - Reports only show data for current teacher

### Deliverables

- [ ] Report routes
- [ ] Report templates
- [ ] Export functionality
- [ ] All tests passing
- [ ] Updated CHANGELOG.md

### Exit Criteria

- [ ] All reports functional
- [ ] Exports work correctly
- [ ] All tests pass
- [ ] Multi-tenancy verified
- [ ] Code reviewed and approved
- [ ] PR merged to main

---

## Phase 10: Documentation & Polish

**Estimated Effort:** 3-4 days
**PR Number:** TBD
**Status:** Not Started
**Depends On:** All previous phases

### Objectives

- Update all user-facing and technical documentation
- Create migration guide for teachers
- Polish UI/UX based on testing feedback
- Final QA and bug fixes

### Tasks

#### 10.1 Update CHANGELOG.md

**File:** `CHANGELOG.md`

- [ ] Add comprehensive v2.0.0 entry
- [ ] List all new features
- [ ] List all changes
- [ ] Include migration notes
- [ ] Include breaking changes (if any)

#### 10.2 Update User Guides

**File:** `docs/user-guides/teacher_manual.md`

- [ ] Add section on Attendance & Payroll Configuration
- [ ] Explain time-based vs. attendance-based
- [ ] Explain tracking controls
- [ ] Explain conflict resolution
- [ ] Add section on Daily Attendance interface
- [ ] Add section on Attendance Log
- [ ] Add section on Reports
- [ ] Include screenshots

**File:** `docs/user-guides/student_guide.md`

- [ ] Update clock-in section
- [ ] Add section on attendance check-in
- [ ] Explain difference between time-based and attendance-based
- [ ] Include screenshots

#### 10.3 Update Technical Documentation

**File:** `docs/technical-reference/architecture.md`

- [ ] Document AttendanceLog architecture
- [ ] Document payroll calculation branching
- [ ] Document hall pass integration

**File:** `docs/technical-reference/database_schema.md`

- [ ] Already updated in Phase 1, verify completeness
- [ ] Add ER diagram if helpful

**File:** `docs/technical-reference/api.md` (if applicable)

- [ ] Document any new API endpoints

#### 10.4 Create Migration Guide

**File:** `docs/migrations/v1-to-v2-migration-guide.md`

- [ ] Explain what's new in v2.0
- [ ] Step-by-step guide for teachers to enable new features
- [ ] How to switch from time-based to attendance-based
- [ ] Common scenarios and recommendations
- [ ] FAQ section

#### 10.5 Update README.md

**File:** `README.md`

- [ ] Update feature list to include flexible attendance
- [ ] Update version number
- [ ] Update screenshots if necessary

#### 10.6 Update DEVELOPMENT.md

**File:** `DEVELOPMENT.md`

- [ ] Move v2.0 features from "Planned" to "Completed"
- [ ] Add any future enhancements to roadmap (v2.1, v3.0 ideas)

#### 10.7 UI/UX Polish

- [ ] Review all new UI for consistency with existing design
- [ ] Accessibility audit (keyboard navigation, screen readers)
- [ ] Mobile responsiveness check
- [ ] Browser compatibility testing (Chrome, Firefox, Safari, Edge)
- [ ] Fix any visual bugs or inconsistencies

#### 10.8 Final QA

- [ ] Complete end-to-end testing scenarios
  - Scenario 1: Teacher enables attendance-based, marks attendance, runs payroll
  - Scenario 2: Teacher uses hybrid tracking, resolves conflicts
  - Scenario 3: Student checks in, teacher edits entry
  - Scenario 4: Teacher switches from time-based to attendance-based mid-year
  - Scenario 5: Hall pass in time-based vs. attendance-based
- [ ] Load testing (40+ students per class)
- [ ] Data integrity verification
- [ ] Multi-tenancy verification across all features
- [ ] Regression testing (all existing features still work)

### Testing Requirements

**Full Regression Suite:**
- [ ] Run ALL existing tests (must pass 100%)
- [ ] Run ALL new v2.0 tests (must pass 100%)

**Manual Testing:**
- [ ] Test all user scenarios end-to-end
- [ ] Test on multiple devices/browsers
- [ ] Test with real-world data volumes

### Deliverables

- [ ] Updated CHANGELOG.md
- [ ] Updated user guides
- [ ] Updated technical documentation
- [ ] Migration guide
- [ ] Updated README.md
- [ ] Updated DEVELOPMENT.md
- [ ] UI/UX polish complete
- [ ] All bugs fixed
- [ ] All tests passing (100% pass rate)

### Exit Criteria

- [ ] All documentation updated
- [ ] Migration guide complete
- [ ] UI/UX polished
- [ ] All QA scenarios pass
- [ ] 100% test pass rate
- [ ] Code reviewed and approved
- [ ] PR merged to main
- [ ] **Version 2.0.0 released!**

---

## Post-Release

### Immediate Post-Release Tasks

- [ ] Monitor for bug reports
- [ ] Create GitHub release with release notes
- [ ] Announce v2.0 release to users
- [ ] Monitor performance metrics
- [ ] Collect user feedback

### v2.1 Planning

Based on feedback, consider:
- [ ] Late = partial pay option
- [ ] Attendance streaks/badges
- [ ] Attendance pattern prediction
- [ ] Student attendance appeals
- [ ] Parent/guardian view
- [ ] Additional reports

---

## Resource Requirements

### Development

- **Developer Time:** ~30-40 days total (can be distributed across multiple developers)
- **Code Reviewer:** Available for 10 PR reviews
- **QA Tester:** Available for final testing phase

### Infrastructure

- **Development Database:** PostgreSQL instance for testing migrations
- **Staging Environment:** For integration testing
- **Production Environment:** For final deployment

### Tools

- **Database Tool:** pgAdmin or similar for schema verification
- **Testing Framework:** pytest (already in use)
- **Documentation:** Markdown editor
- **Version Control:** Git/GitHub (already in use)

---

## Risk Mitigation

### Identified Risks

1. **Data Leakage (Multi-Tenancy)**
   - **Risk:** Queries not scoped by join_code expose data
   - **Mitigation:** Comprehensive multi-tenancy tests in every phase
   - **Owner:** All developers

2. **Backward Compatibility Breaking**
   - **Risk:** Changes break existing time-based functionality
   - **Mitigation:** Regression tests, careful defaults, incremental rollout
   - **Owner:** Lead developer

3. **Performance Degradation**
   - **Risk:** New queries slow down system
   - **Mitigation:** Indexes on AttendanceLog, performance testing
   - **Owner:** Database specialist

4. **User Confusion**
   - **Risk:** Teachers don't understand new features
   - **Mitigation:** Clear documentation, migration guide, help text
   - **Owner:** Technical writer / Product owner

5. **Scope Creep**
   - **Risk:** Adding features not in spec during development
   - **Mitigation:** Strict adherence to spec, defer new ideas to v2.1
   - **Owner:** Product owner

---

## Success Criteria

### Technical Metrics

- [ ] All tests pass (100% pass rate)
- [ ] No data leakage (multi-tenancy verified)
- [ ] No performance regression (page load times similar to v1.x)
- [ ] Database migrations work (upgrade and downgrade)
- [ ] Code coverage maintained or improved

### Functional Metrics

- [ ] Teachers can configure payroll type
- [ ] Teachers can mark attendance (if enabled)
- [ ] Students can check in (if enabled)
- [ ] Payroll calculates correctly for both types
- [ ] Hall passes behave correctly for both types
- [ ] Reports generate correctly

### Quality Metrics

- [ ] All documentation updated
- [ ] Migration guide complete and tested
- [ ] UI is accessible (WCAG 2.1 AA)
- [ ] UI is mobile-responsive
- [ ] No critical bugs at release

---

## Timeline Estimate

**Total Estimated Duration:** 10-12 weeks (assuming one developer)

| Phase | Duration | Cumulative |
|-------|----------|------------|
| Phase 1: Database Schema | 1-2 days | 2 days |
| Phase 2: Settings UI | 2-3 days | 5 days |
| Phase 3: Attendance Utilities | 2-3 days | 8 days |
| Phase 4: Daily Attendance Interface | 4-5 days | 13 days |
| Phase 5: Attendance Log Interface | 4-5 days | 18 days |
| Phase 6: Payroll Calculation | 3-4 days | 22 days |
| Phase 7: Hall Pass Integration | 3-4 days | 26 days |
| Phase 8: Student UI Updates | 3-4 days | 30 days |
| Phase 9: Reporting & Analytics | 4-5 days | 35 days |
| Phase 10: Documentation & Polish | 3-4 days | 39 days |

**Note:** Timeline assumes one developer working full-time. Multiple developers can work in parallel on independent phases, potentially reducing total calendar time.

---

## Version History

| Date       | Version | Author | Changes                      |
|------------|---------|--------|------------------------------|
| 2026-01-03 | 1.0     | Claude | Initial roadmap              |

---

**Status:** Planning
**Approval Required:** Product Owner, Lead Developer, QA Lead
**Next Steps:** Review and approve roadmap, then begin Phase 1
