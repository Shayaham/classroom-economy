# Version 2.0 Attendance & Payroll System - Design Decisions

**Document Type:** Architecture Decision Record (ADR)
**Feature:** Flexible Attendance & Payroll System
**Version:** 2.0.0
**Status:** Planning / Proposed
**Date:** 2026-01-03
**Last Updated:** 2026-01-03

---

## Purpose

This document records the key architectural and design decisions made for the Version 2.0 Attendance & Payroll System. It captures the reasoning, alternatives considered, and trade-offs for major decisions.

Future developers (human or AI) should refer to this document to understand **why** the system is designed the way it is.

---

## Table of Contents

1. [Decision: Dual Payroll System (Not Replacement)](#decision-1-dual-payroll-system-not-replacement)
2. [Decision: New AttendanceLog Table (Not Modify TapEvent)](#decision-2-new-attendancelog-table-not-modify-tapevent)
3. [Decision: Separate Tracking Controls (Student vs Teacher)](#decision-3-separate-tracking-controls-student-vs-teacher)
4. [Decision: Conflict Resolution Setting](#decision-4-conflict-resolution-setting)
5. [Decision: Hall Pass Behavior Based on Payroll Type](#decision-5-hall-pass-behavior-based-on-payroll-type)
6. [Decision: Daily Attendance Tab Visibility](#decision-6-daily-attendance-tab-visibility)
7. [Decision: System-Generated Entries Cannot Be Edited](#decision-7-system-generated-entries-cannot-be-edited)
8. [Decision: Backdating Allowed with Warnings](#decision-8-backdating-allowed-with-warnings)
9. [Decision: Period-Level Attendance Control](#decision-9-period-level-attendance-control)
10. [Decision: Attendance-Based Payroll Has No Check-Out](#decision-10-attendance-based-payroll-has-no-check-out)
11. [Decision: Incremental Implementation (10 Phases)](#decision-11-incremental-implementation-10-phases)
12. [Decision: Per-join_code Settings (Not Global)](#decision-12-per-join_code-settings-not-global)

---

## Decision 1: Dual Payroll System (Not Replacement)

### Context

The existing system uses time-based payroll (students clock in/out, paid by hours worked). We need to support classrooms without 1:1 device access.

### Options Considered

**Option A: Replace time-based with attendance-based**
- Remove clock-in/out entirely
- Everyone uses the new simpler system
- Pros: Simpler codebase, one system to maintain
- Cons: Breaking change, forces migration, loses precision for teachers who want it

**Option B: Add attendance-based alongside time-based (dual system)**
- Keep existing time-based unchanged
- Add new attendance-based as alternative
- Teacher chooses which to use via setting
- Pros: Backward compatible, flexible, no forced migration
- Cons: More complex codebase, two systems to maintain

**Option C: Hybrid system with automatic fallback**
- Try time-based first, fall back to attendance if no devices
- Pros: "Smart" system adapts automatically
- Cons: Confusing behavior, unpredictable, hard to debug

### Decision

**Selected: Option B (Dual System)**

### Rationale

- **Backward compatibility is critical** - Teachers using the current system should see no changes
- **Different teachers have different needs** - Some want precision (time-based), some want simplicity (attendance-based)
- **No forced migration** - Schools can adopt at their own pace
- **Clear, predictable behavior** - Teacher explicitly chooses mode, no surprises

The added complexity of maintaining two systems is worth the flexibility and non-breaking nature of the change.

### Consequences

- Need to maintain both calculation methods in `payroll.py`
- Need to branch UI logic based on `payroll_type`
- Need to test both modes thoroughly
- Documentation must explain differences clearly

---

## Decision 2: New AttendanceLog Table (Not Modify TapEvent)

### Context

The existing `TapEvent` table stores clock-in/out events. We need to store attendance data for the new system.

### Options Considered

**Option A: Extend TapEvent table**
- Add new columns to `TapEvent`: `attendance_status`, `payroll_type`, etc.
- Reuse existing table for both time and attendance tracking
- Pros: One table for all attendance data
- Cons: Table becomes overloaded, existing queries break, confusing semantics

**Option B: Create new AttendanceLog table**
- Separate table for attendance-based entries
- `TapEvent` remains unchanged for time-based
- Pros: Clean separation, no risk to existing data, clear semantics
- Cons: Two tables to manage, more complexity

**Option C: Replace TapEvent entirely**
- Create new unified table, migrate all historical data
- Pros: Fresh start, single source of truth
- Cons: Massive migration, high risk, breaks backward compatibility

### Decision

**Selected: Option B (New AttendanceLog Table)**

### Rationale

- **Risk mitigation** - Leave existing `TapEvent` table untouched, no risk of breaking time-based system
- **Clear separation of concerns** - `TapEvent` = time tracking, `AttendanceLog` = attendance tracking
- **Different data models** - Attendance entries have different fields (created_by, entry_type, etc.)
- **No migration needed** - Don't need to backfill historical data

The parallel table approach is cleaner and safer than trying to retrofit `TapEvent`.

### Consequences

- Payroll calculation must query different tables based on `payroll_type`
- Reports need to handle both data sources
- Hall passes create entries in both tables (if needed)
- Future: Could consolidate if needed, but not necessary now

---

## Decision 3: Separate Tracking Controls (Student vs Teacher)

### Context

We need to control who can mark attendance: students, teachers, or both.

### Options Considered

**Option A: Single toggle (Student or Teacher)**
- One setting: "Who marks attendance?"
- Values: "Students", "Teachers"
- Pros: Simplest UI
- Cons: No hybrid mode, teachers can't correct student mistakes

**Option B: Two separate toggles (Student AND Teacher)**
- `student_tracking_enabled` - Students can mark attendance
- `teacher_tracking_enabled` - Teachers can mark attendance
- Both can be True (hybrid mode)
- Pros: Maximum flexibility, supports correction scenarios
- Cons: More complex, need conflict resolution

**Option C: Role-based with override**
- Primary tracker (student or teacher)
- Override permission for the other role
- Pros: Clear primary responsibility
- Cons: Confusing UI, hard to explain

### Decision

**Selected: Option B (Two Separate Toggles)**

### Rationale

- **Real-world scenario:** Teacher wants students to self-report, but needs ability to correct mistakes
- **Flexibility:** Supports student-only, teacher-only, and hybrid modes
- **Gradual transition:** Teacher can start with hybrid, move to student-only once students are trained
- **Special cases:** Teacher can mark absent students who never logged in

Conflict resolution is needed, but the flexibility is worth it.

### Consequences

- Need `conflict_resolution` setting to handle overlaps
- Need to track `created_by` and `modified_by` in `AttendanceLog`
- UI must clearly show who created each entry
- Students need visibility when teacher overrides their entry

---

## Decision 4: Conflict Resolution Setting

### Context

When both student and teacher can mark attendance (hybrid mode), how do we handle duplicate entries for the same day?

### Options Considered

**Option A: Last Entry Wins**
- Most recent entry overwrites previous
- Simple, predictable chronological rule
- Pros: Easy to understand, fair to both parties
- Cons: Teacher correction could be overwritten by student

**Option B: Teacher Priority**
- Teacher entry always takes precedence
- Student cannot overwrite teacher entry
- Pros: Teacher has final authority
- Cons: Student can't correct if teacher made mistake

**Option C: Prompt Teacher to Resolve**
- System detects conflict, asks teacher which to keep
- Pros: Most accurate
- Cons: Creates interruption, requires teacher action

**Option D: Both (Configurable)**
- Teacher chooses conflict resolution strategy
- Can select "Last Entry Wins" or "Teacher Priority"
- Pros: Flexibility, teacher controls their classroom
- Cons: One more setting to configure

### Decision

**Selected: Option D (Configurable with Default)**

Default: "Last Entry Wins"
Alternative: "Teacher Priority"

### Rationale

- **Different classrooms have different trust levels** - Some teachers trust students, others want final control
- **Default to fairness** - "Last Entry Wins" is the most intuitive for first-time users
- **Option for control** - Teachers can switch to "Teacher Priority" if students are gaming the system
- **Clear rules** - No manual intervention needed, system applies setting automatically

### Consequences

- Need to implement both conflict resolution modes
- Need to explain difference clearly in settings UI
- Need to test both modes thoroughly
- Need to show conflict resolution in effect (e.g., show "overridden" status)

---

## Decision 5: Hall Pass Behavior Based on Payroll Type

### Context

In time-based payroll, hall passes pause time tracking. In attendance-based, time doesn't matter. How should hall passes work?

### Options Considered

**Option A: Always Pause Time**
- Hall passes always pause time tracking regardless of payroll type
- Pros: Consistent behavior
- Cons: Doesn't make sense for attendance-based (no time to pause)

**Option B: Never Pause Time**
- Hall passes only track location, never affect payroll
- Pros: Simplest implementation
- Cons: Breaks existing time-based behavior, students could abuse

**Option C: Conditional Behavior (Based on Payroll Type)**
- Time-based: Pause time (existing behavior)
- Attendance-based: Track only, no payroll impact
- Pros: Appropriate behavior for each mode
- Cons: Different behavior could confuse teachers switching modes

### Decision

**Selected: Option C (Conditional Behavior)**

- **Time-based payroll:** Hall pass pauses time tracking (current behavior)
- **Attendance-based payroll:** Hall pass tracked for accountability only, no payroll impact

### Rationale

- **Semantically correct** - In attendance-based, student is still "present" even if on hall pass
- **Maintains existing behavior** - Time-based teachers see no change
- **Simpler for students** - In attendance-based, no need to worry about time effects
- **Still accountable** - Hall passes are logged in `AttendanceLog` for tracking

### Consequences

- Hall pass creation logic must check `payroll_type`
- Hall pass entries in `AttendanceLog` marked as `is_system_generated=True`
- UI should show hall pass activity even if it doesn't affect pay
- Reports can still show hall pass usage for accountability

---

## Decision 6: Daily Attendance Tab Visibility

### Context

The new Daily Attendance tab is for teachers to mark student attendance. When should it be shown?

### Options Considered

**Option A: Always Visible**
- Every teacher sees the Daily Attendance tab
- Pros: Feature discovery, always accessible
- Cons: Clutters UI for teachers not using it, confusing if disabled

**Option B: Show Only if Teacher Tracking Enabled**
- Tab only appears if `teacher_tracking_enabled = True`
- Pros: Clean UI, only shown when relevant
- Cons: Teachers might not discover feature

**Option C: Show With Disabled State**
- Tab always visible but disabled/grayed out if not enabled
- Clicking shows "Enable in settings to use this feature"
- Pros: Feature discovery with explanation
- Cons: Still clutters UI

### Decision

**Selected: Option B (Show Only if Enabled)**

### Rationale

- **Clean UI** - Don't show features that aren't configured
- **Settings-driven** - Teacher explicitly enables feature, then it appears
- **Attendance Log still visible** - Teachers can always view history even if they can't edit daily
- **Documentation handles discovery** - User guides explain how to enable

The UI should be clean and contextual. If feature isn't enabled, don't show it.

### Consequences

- Need to check `teacher_tracking_enabled` before rendering tab
- Need clear documentation on enabling the feature
- Settings page should explain what enabling teacher tracking does
- Teachers might not discover feature without reading docs (acceptable)

---

## Decision 7: System-Generated Entries Cannot Be Edited

### Context

Some attendance entries are created automatically by the system (e.g., hall pass events). Should these be editable?

### Options Considered

**Option A: All Entries Editable**
- Teacher can edit any entry, including system-generated
- Pros: Maximum flexibility
- Cons: Breaks audit trail, could hide hall pass abuse

**Option B: System Entries Read-Only**
- Entries with `is_system_generated=True` cannot be edited or deleted
- Pros: Preserves audit trail, maintains data integrity
- Cons: Less flexibility if system makes a mistake

**Option C: System Entries Deletable Only**
- Can't edit, but can delete if wrong
- Pros: Allows removing errors
- Cons: Removes evidence, could hide abuse

### Decision

**Selected: Option B (System Entries Read-Only)**

### Rationale

- **Audit trail integrity** - Hall pass records should be tamper-proof
- **Accountability** - Can't hide hall pass abuse by editing entries
- **Data integrity** - System-generated data should be trusted
- **Manual override available** - Teacher can create manual entry to override if needed (e.g., "not actually on hall pass")

System data should be sacrosanct. If there's an error, it should be corrected via offsetting entry, not by editing history.

### Consequences

- Need `is_system_generated` flag in `AttendanceLog`
- Edit/Delete buttons disabled in UI for these entries
- Tooltip explains: "System-generated entries cannot be edited"
- Teacher can create manual entry to document correction if needed

---

## Decision 8: Backdating Allowed with Warnings

### Context

Should teachers be allowed to create/edit attendance entries for past dates?

### Options Considered

**Option A: No Backdating**
- Can only create/edit entries for current day
- Pros: Prevents abuse, maintains data integrity
- Cons: Inflexible, can't correct mistakes

**Option B: Unlimited Backdating**
- Teacher can create/edit entries for any date
- No warnings or restrictions
- Pros: Maximum flexibility
- Cons: Could affect already-paid payroll, no safeguards

**Option C: Backdating with Payroll Impact Warnings**
- Allow backdating for any date
- Warn if edit affects unpaid payroll period
- No warning if payroll already paid (just historical record)
- Pros: Flexibility with safety, clear communication
- Cons: Requires payroll period tracking

### Decision

**Selected: Option C (Backdating with Warnings)**

### Rationale

- **Not official attendance** - System is educational, not official school records, so flexibility is okay
- **Real-world scenario** - Teacher forgets to mark attendance, wants to backfill
- **Payroll integrity** - Warn if it affects unpaid payroll so teacher knows consequences
- **Historical corrections** - If payroll already paid, backdating is just record-keeping

Flexibility is important, but users should be informed of consequences.

### Consequences

- Need to check if edited entry is in unpaid payroll period
- Show warning dialog if it affects unpaid payroll
- Allow backdating even with warning (user confirms)
- Track `modified_at` and `modified_by` for audit trail

---

## Decision 9: Period-Level Attendance Control

### Context

Teachers may want different attendance rules for different class periods (e.g., students track periods 1-3, teacher tracks period 4).

### Options Considered

**Option A: Global Setting Only**
- `student_tracking_enabled` applies to all periods
- Pros: Simpler configuration
- Cons: No per-period flexibility

**Option B: Per-Period Override**
- Global setting + per-period `attendance_enabled` toggle
- Each `TeacherBlock` can override global setting
- Pros: Maximum flexibility, supports special cases
- Cons: More complex UI and logic

**Option C: Per-Period Only (No Global)**
- No global setting, configure each period individually
- Pros: Explicit control
- Cons: Tedious for teachers with many periods

### Decision

**Selected: Option B (Global + Per-Period Override)**

- Global: `student_tracking_enabled` in `PayrollSettings`
- Per-Period: `attendance_enabled` in `TeacherBlock`

**Logic:** Period override takes precedence if set to False

### Rationale

- **Real-world scenario** - Special ed or intervention periods need different rules
- **Convenience** - Set global default, override only where needed
- **Existing pattern** - Current clock-in/out already has per-period controls
- **Flexibility** - Supports edge cases without complicating common case

### Consequences

- Need `attendance_enabled` field in `TeacherBlock`
- UI shows per-period toggles (similar to existing clock-in controls)
- Logic must check both global and period-level settings
- Student UI must respect period-level override

---

## Decision 10: Attendance-Based Payroll Has No Check-Out

### Context

In attendance-based payroll, duration doesn't matter, only presence. Do students need to check out?

### Options Considered

**Option A: Require Check-In and Check-Out**
- Students check in at start, check out at end
- System ignores duration but tracks both events
- Pros: Consistent with time-based behavior
- Cons: Unnecessary friction, confusing ("why check out if time doesn't matter?")

**Option B: Check-In Only, No Check-Out**
- Students check in once to mark present
- No check-out needed or shown
- Pros: Simpler, matches attendance semantics
- Cons: Different from time-based behavior

**Option C: Automatic Check-Out**
- Students check in, system auto-checks out at end of period
- Pros: Consistent event pairs
- Cons: Unnecessary complexity, no value added

### Decision

**Selected: Option B (Check-In Only)**

### Rationale

- **Semantically correct** - Attendance is binary (present or not), not a duration
- **Reduced friction** - One less thing for students to remember
- **Clearer purpose** - "Mark yourself present" is clearer than "clock in"
- **UI clarity** - Can use "Check In" instead of "Clock In" to signal different behavior

The simpler model aligns with the purpose of attendance-based payroll.

### Consequences

- Student UI shows "Check In" button, not "Clock In"
- After check-in, show confirmation: "You're marked present for today!"
- No "Check Out" button in attendance-based mode
- Need to clearly document this difference in user guides

---

## Decision 11: Incremental Implementation (10 Phases)

### Context

This is a large feature. Should it be built all at once or incrementally?

### Options Considered

**Option A: Single Large PR**
- Implement entire feature in one go
- Merge when 100% complete
- Pros: Cohesive implementation, fewer PRs to review
- Cons: High risk, hard to review, blocks other work, merge conflicts

**Option B: Incremental Phases (10 PRs)**
- Break into logical phases (schema → settings → UI → integration)
- Each phase is independently testable
- Merge as phases complete
- Pros: Lower risk, easier review, parallel work possible
- Cons: More PRs, need careful sequencing

**Option C: Feature Branch with Multiple Merge Points**
- Work on feature branch, merge to main at milestones
- Pros: Flexibility in development
- Cons: Long-lived feature branch, merge conflicts, harder to review

### Decision

**Selected: Option B (Incremental Phases)**

**Phase Sequence:**
1. Database Schema
2. Settings UI
3. Attendance Utilities
4. Daily Attendance Interface
5. Attendance Log Interface
6. Payroll Calculation Update
7. Hall Pass Integration
8. Student UI Updates
9. Reporting & Analytics
10. Documentation & Polish

### Rationale

- **Risk mitigation** - Small PRs are easier to review and safer to merge
- **Early feedback** - Can adjust based on feedback after each phase
- **Parallel work** - Other developers can work on other features
- **Testability** - Each phase independently testable
- **Rollback** - Easier to revert a small phase than a massive change

The overhead of multiple PRs is worth the reduced risk and better quality.

### Consequences

- Each phase must be independently functional (even if feature not complete)
- Need to maintain backward compatibility throughout all phases
- Testing must be comprehensive at each phase
- Documentation must be updated incrementally
- Feature flags might be needed to hide incomplete features

---

## Decision 12: Per-join_code Settings (Not Global)

### Context

Should attendance/payroll settings be global (system-wide), per-teacher, or per-class period (join_code)?

### Options Considered

**Option A: Global Settings**
- One setting applies to entire system
- All teachers use same payroll type
- Pros: Simplest to implement
- Cons: No flexibility, forces all teachers to use same model

**Option B: Per-Teacher Settings**
- Each teacher (`Admin`) configures their preferences
- Applies to all their class periods
- Pros: Teacher autonomy
- Cons: Teacher might want different settings for different periods

**Option C: Per-join_code Settings**
- Each class period (`join_code`) has its own settings
- Stored in `PayrollSettings` table (already keyed by `join_code`)
- Pros: Maximum flexibility, different periods can use different models
- Cons: More configuration work for teachers with many periods

### Decision

**Selected: Option C (Per-join_code)**

### Rationale

- **Existing architecture** - `PayrollSettings` already keyed by `join_code`
- **Multi-tenancy** - Aligns with existing multi-tenant scoping
- **Real-world scenario** - Teacher might want time-based for honors class, attendance-based for intervention class
- **Flexibility** - Supports edge cases without limiting common cases
- **Consistency** - All settings are per-`join_code` in current system

The existing architecture already supports this, so it's the natural choice.

### Consequences

- Settings UI must show current `join_code` context
- Teacher with multiple periods configures each separately (or could batch in future)
- Queries always filter by `join_code` (existing pattern)
- Documentation must explain settings are per-class period

---

## Summary of Key Decisions

| Decision | Choice | Primary Reason |
|----------|--------|----------------|
| Payroll System | Dual (Time + Attendance) | Backward compatibility |
| Data Storage | New AttendanceLog table | Risk mitigation |
| Tracking Control | Separate toggles | Flexibility |
| Conflict Resolution | Configurable | Different classroom needs |
| Hall Pass Behavior | Conditional (payroll type) | Semantic correctness |
| Daily Attendance Visibility | Only if enabled | Clean UI |
| System Entry Editing | Read-only | Audit trail integrity |
| Backdating | Allowed with warnings | Flexibility with safety |
| Period Control | Global + override | Real-world scenarios |
| Check-Out (Attendance) | Not required | Semantic simplicity |
| Implementation | 10 incremental phases | Risk mitigation |
| Settings Scope | Per-join_code | Existing architecture |

---

## Future Decisions Needed

These decisions were deferred to future iterations:

1. **Late = Full Pay vs. Partial Pay** - Defer to v2.1 based on teacher feedback
2. **Attendance Streaks/Gamification** - Defer to v2.1 if requested
3. **Bulk Sign-In Remember Pattern** - Defer to v2.1 if requested
4. **Student Notifications** - Defer notification method to v2.1
5. **Attendance Appeals** - Defer formal process to v2.1
6. **QR Code / Geofencing** - Defer to v3.0 (advanced features)

---

## Lessons for Future Features

### What Worked Well

- **Dual system approach** - Adding alongside (not replacing) enables safe rollout
- **Incremental phases** - Reduces risk, improves quality
- **Settings-driven behavior** - Flexibility without code changes

### Pitfalls to Avoid

- **Scope creep** - Resist adding "nice-to-have" features that aren't in spec
- **Breaking changes** - Always maintain backward compatibility
- **Global settings** - Per-`join_code` settings align with existing architecture

### Guidelines

- When in doubt, prefer **flexibility over simplicity**
- When in doubt, prefer **backward compatibility over new features**
- When in doubt, prefer **incremental rollout over big bang**

---

## Document History

| Date       | Version | Author | Changes                     |
|------------|---------|--------|-----------------------------|
| 2026-01-03 | 1.0     | Claude | Initial design decisions    |

---

**Status:** Proposed
**Next Review:** After Phase 1 (Database Schema) implementation
**Approval Required:** Product Owner, Lead Developer

---

## References

- Full Specification: `docs/specifications/v2.0-flexible-attendance-payroll.md`
- Agent Instructions: `.claude/rules/attendance-payroll-v2.md`
- User Wireframes: (provided by product owner)
- Related ADRs: `docs/design-decisions/` (other decision records)
